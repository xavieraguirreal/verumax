<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verumax - Editor de Templates de Certificados</title>
    <!-- Google Fonts para tipografías elegantes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Antic+Didone&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Josefin+Sans:wght@400;600&family=Lora:ital,wght@0,400;0,600;1,400&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&family=Parisienne&family=Pinyon+Script&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Raleway:wght@400;500;600&family=Roboto:wght@400;500&family=Source+Sans+3:wght@400;600&family=Special+Elite&family=Tangerine:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--gray-800);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--gray-500);
        }

        .btn-outline {
            background: transparent;
            color: var(--gray-300);
            border: 1px solid var(--gray-600);
        }

        .btn-outline:hover {
            background: var(--gray-700);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 52px);
        }

        /* Left Panel - Elements */
        .left-panel {
            width: 240px;
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .elements-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .element-category {
            margin-bottom: 1rem;
        }

        .element-category-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            padding: 0.5rem;
            letter-spacing: 0.05em;
        }

        .element-item {
            padding: 0.625rem 0.75rem;
            margin: 0.25rem 0;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            cursor: grab;
            font-size: 0.8125rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.15s;
        }

        .element-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .element-item:active {
            cursor: grabbing;
        }

        .element-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            background: var(--gray-200);
            padding: 2rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: default;
        }

        .canvas-container.panning {
            cursor: grab;
        }

        .canvas-container.panning:active {
            cursor: grabbing;
        }

        .canvas-viewport {
            transform-origin: center center;
            transition: none;
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* Zoom indicator */
        .zoom-indicator {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 50;
            user-select: none;
        }

        .zoom-indicator button {
            width: 24px;
            height: 24px;
            border: none;
            background: var(--gray-700);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            line-height: 1;
        }

        .zoom-indicator button:hover {
            background: var(--gray-600);
        }

        .zoom-level {
            min-width: 50px;
            text-align: center;
            font-weight: 500;
        }

        .canvas {
            position: relative;
            background: white;
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .canvas.landscape {
            width: 842px; /* A4 landscape at 72dpi */
            height: 595px;
        }

        .canvas.portrait {
            width: 595px;
            height: 842px;
        }

        .canvas-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0.3;
            display: none;
        }

        .canvas-grid.visible {
            display: block;
        }

        /* Canvas Elements */
        .canvas-element {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 2px solid transparent;
            padding: 4px;
            min-width: 20px;
            min-height: 20px;
        }

        .canvas-element:hover {
            border-color: var(--primary);
        }

        .canvas-element.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .canvas-element.dragging {
            opacity: 0.8;
            z-index: 1000;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border: 2px solid white;
            border-radius: 2px;
            display: none;
        }

        .canvas-element.selected .resize-handle {
            display: block;
        }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Group styles */
        .canvas-element.grouped {
            border-color: #8b5cf6;
        }

        .canvas-element.grouped:hover {
            border-color: #7c3aed;
        }

        .canvas-element.grouped.selected {
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }

        .group-indicator {
            position: absolute;
            top: -18px;
            left: 0;
            background: #8b5cf6;
            color: white;
            font-size: 0.6rem;
            padding: 1px 6px;
            border-radius: 3px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 10;
        }

        .layer-item.is-group {
            background: rgba(139, 92, 246, 0.1);
            border-color: #8b5cf6;
        }

        .layer-item .group-badge {
            background: #8b5cf6;
            color: white;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 4px;
        }

        .element-text {
            white-space: nowrap;
        }

        .element-paragraph {
            white-space: normal;
            line-height: 1.4;
            overflow: hidden;
        }

        /* Tabs para párrafos estudiante/docente */
        .paragraph-tab {
            transition: all 0.2s ease;
        }
        .paragraph-tab:hover {
            background: var(--gray-100) !important;
        }
        .paragraph-tab.active {
            color: var(--primary) !important;
            border-bottom-color: var(--primary) !important;
            font-weight: 600 !important;
        }
        .paragraph-panel {
            animation: fadeIn 0.15s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .element-image {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            border: 2px dashed var(--gray-300);
            color: var(--gray-400);
            font-size: 0.75rem;
            text-align: center;
            min-width: 60px;
            min-height: 60px;
        }

        .element-line {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            min-height: 4px;
        }

        .element-line.horizontal {
            min-height: 4px;
            min-width: 100px;
        }

        .element-line.vertical {
            min-width: 4px;
            min-height: 100px;
        }

        .element-line .line-inner {
            background: currentColor;
        }

        .element-line.horizontal .line-inner {
            width: 100%;
            height: 2px;
        }

        .element-line.vertical .line-inner {
            width: 2px;
            height: 100%;
        }

        .element-line-firma {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            min-width: 150px;
            min-height: 30px;
        }

        .element-line-firma .firma-line {
            width: 100%;
            height: 1px;
            background: currentColor;
        }

        .element-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 200px;
            min-height: 20px;
        }

        .element-separator .sep-inner {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .element-separator .sep-line {
            flex: 1;
            height: 1px;
            background: currentColor;
        }

        .element-separator .sep-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            margin: 0 8px;
        }

        /* Stamp element */
        .element-stamp {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Special Elite', 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 2px solid currentColor;
            padding: 4px 8px;
            box-sizing: border-box;
        }

        .element-stamp .stamp-text {
            text-align: center;
            width: 100%;
        }

        /* Copy format indicator */
        .toolbar-btn.has-format {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        /* Align dropdown */
        .align-dropdown {
            position: relative;
        }

        .align-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            z-index: 1000;
            min-width: 200px;
        }

        .align-dropdown:hover .align-dropdown-content,
        .align-dropdown.open .align-dropdown-content {
            display: block;
        }

        .align-section {
            padding: 0.25rem 0;
        }

        .align-section:not(:last-child) {
            border-bottom: 1px solid var(--gray-100);
            margin-bottom: 0.25rem;
        }

        .align-section-title {
            font-size: 0.65rem;
            color: var(--gray-400);
            text-transform: uppercase;
            padding: 0.25rem 0.5rem;
            letter-spacing: 0.05em;
        }

        .align-buttons {
            display: flex;
            gap: 2px;
            padding: 0 0.25rem;
        }

        .align-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            transition: all 0.15s;
        }

        .align-btn:hover:not(:disabled) {
            background: var(--gray-100);
            color: var(--primary);
        }

        .align-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .align-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Right Panel - Properties */
        .right-panel {
            width: 280px;
            background: white;
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .properties-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .property-group {
            margin-bottom: 1.25rem;
        }

        .property-group-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .property-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.625rem;
            gap: 0.5rem;
        }

        .property-label {
            font-size: 0.8125rem;
            color: var(--gray-600);
            width: 70px;
            flex-shrink: 0;
        }

        .property-input {
            flex: 1;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.8125rem;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .property-input-small {
            width: 70px;
        }

        /* Textarea resize mejorado */
        textarea.property-input {
            min-height: 80px;
            max-height: 300px;
            resize: vertical;
            line-height: 1.4;
        }

        /* Barra de formato */
        .text-format-toolbar {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            background: var(--gray-50);
            border-radius: 4px;
            border: 1px solid var(--gray-200);
        }

        .text-format-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.15s;
        }

        .text-format-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .text-format-btn.bold { font-weight: 700; }
        .text-format-btn.italic { font-style: italic; }

        .format-help {
            font-size: 0.65rem;
            color: var(--gray-400);
            margin-top: 0.25rem;
        }

        .property-select {
            flex: 1;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.8125rem;
            background: white;
        }

        .property-color {
            width: 36px;
            height: 28px;
            padding: 2px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
        }

        .property-row-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .property-row-split .property-unit {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .property-row-split label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Layers Panel */
        .layers-panel {
            border-top: 1px solid var(--gray-200);
            max-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .layers-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .layer-item {
            padding: 0.5rem 0.75rem;
            margin: 0.25rem 0;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .layer-item:hover {
            background: var(--gray-100);
        }

        .layer-item.selected {
            background: rgba(37, 99, 235, 0.1);
            border-color: var(--primary);
        }

        .layer-actions {
            display: flex;
            gap: 0.25rem;
        }

        .layer-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        .layer-btn:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--gray-600);
            margin: 0 0.5rem;
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
        }

        .toolbar-btn:hover {
            background: var(--gray-700);
            color: white;
        }

        .toolbar-btn.active {
            background: var(--primary);
            color: white;
        }

        .toolbar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Status Bar */
        .status-bar {
            background: var(--gray-800);
            color: var(--gray-400);
            padding: 0.375rem 1rem;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-400);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            z-index: 2000;
            display: none;
        }

        .toast.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Keyboard shortcuts hint */
        .shortcuts-hint {
            position: fixed;
            bottom: 4rem;
            right: 1rem;
            background: var(--gray-800);
            color: var(--gray-300);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            display: none;
            z-index: 100;
        }

        .shortcuts-hint.visible {
            display: block;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0;
            gap: 2rem;
        }

        .shortcut-key {
            background: var(--gray-700);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-family: monospace;
        }

        /* Preview Modal Styles */
        .preview-upload-group {
            margin-bottom: 0.75rem;
        }

        .preview-upload-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .preview-upload-box {
            border: 2px dashed var(--gray-300);
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            background: var(--gray-50);
            transition: all 0.15s;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-upload-box:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .preview-upload-box.has-image {
            border-style: solid;
            border-color: var(--primary);
        }

        .preview-upload-box span {
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        .preview-field {
            margin-bottom: 0.5rem;
        }

        .preview-field label {
            display: block;
            font-size: 0.7rem;
            color: var(--gray-500);
            margin-bottom: 0.125rem;
        }

        .preview-field .property-input {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Preview mode indicator */
        .preview-mode-active {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .preview-badge {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            font-size: 0.7rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Client Profile Pills */
        .profile-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.625rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .profile-pill:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .profile-pill .delete-profile {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            color: inherit;
            opacity: 0.6;
        }

        .profile-pill .delete-profile:hover {
            background: rgba(0,0,0,0.2);
            opacity: 1;
        }

        .no-profiles {
            font-size: 0.75rem;
            color: var(--gray-400);
            font-style: italic;
        }

        /* Rulers and Guides */
        .rulers-container {
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .rulers-container .canvas-wrapper {
            box-shadow: none;
        }

        .ruler-corner {
            width: 25px;
            height: 25px;
            background: var(--gray-200);
            border-right: 1px solid var(--gray-300);
            border-bottom: 1px solid var(--gray-300);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: var(--gray-500);
        }

        .ruler-corner:hover {
            background: var(--gray-300);
        }

        .ruler-corner.guides-active {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .ruler-horizontal-wrapper {
            display: flex;
        }

        .ruler-horizontal {
            height: 25px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-300);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .ruler-horizontal:hover {
            background: var(--gray-200);
        }

        .ruler-vertical-wrapper {
            display: flex;
        }

        .ruler-vertical {
            width: 25px;
            background: var(--gray-100);
            border-right: 1px solid var(--gray-300);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
        }

        .ruler-vertical:hover {
            background: var(--gray-200);
        }

        .ruler-tick {
            position: absolute;
            background: var(--gray-400);
        }

        .ruler-horizontal .ruler-tick {
            width: 1px;
            bottom: 0;
        }

        .ruler-horizontal .ruler-tick.major {
            height: 12px;
        }

        .ruler-horizontal .ruler-tick.minor {
            height: 6px;
        }

        .ruler-vertical .ruler-tick {
            height: 1px;
            right: 0;
        }

        .ruler-vertical .ruler-tick.major {
            width: 12px;
        }

        .ruler-vertical .ruler-tick.minor {
            width: 6px;
        }

        .ruler-number {
            position: absolute;
            font-size: 9px;
            color: var(--gray-500);
            font-family: monospace;
        }

        .ruler-horizontal .ruler-number {
            top: 2px;
            transform: translateX(-50%);
        }

        .ruler-vertical .ruler-number {
            left: 2px;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: left center;
            white-space: nowrap;
        }

        .guide-line {
            position: absolute;
            z-index: 100;
            pointer-events: auto;
        }

        .guide-line.horizontal {
            left: 0;
            right: 0;
            height: 1px;
            background: #ef4444;
            cursor: ns-resize;
        }

        .guide-line.vertical {
            top: 0;
            bottom: 0;
            width: 1px;
            background: #ef4444;
            cursor: ew-resize;
        }

        .guide-line::before {
            content: '';
            position: absolute;
            background: transparent;
        }

        .guide-line.horizontal::before {
            left: 0;
            right: 0;
            top: -3px;
            height: 7px;
        }

        .guide-line.vertical::before {
            top: 0;
            bottom: 0;
            left: -3px;
            width: 7px;
        }

        .guide-line:hover {
            background: #dc2626;
        }

        .guide-line.dragging {
            background: #b91c1c;
        }

        .guide-preview {
            position: absolute;
            z-index: 99;
            pointer-events: none;
            opacity: 0.5;
        }

        .guide-preview.horizontal {
            left: 0;
            right: 0;
            height: 1px;
            background: #ef4444;
            border-top: 1px dashed #ef4444;
        }

        .guide-preview.vertical {
            top: 0;
            bottom: 0;
            width: 1px;
            background: #ef4444;
            border-left: 1px dashed #ef4444;
        }

        .guides-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .guides-container .guide-line {
            pointer-events: auto;
        }

        .guide-tooltip {
            position: fixed;
            background: var(--gray-800);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: monospace;
            pointer-events: none;
            z-index: 2000;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M3 9h18M9 21V9"/>
            </svg>
            Verumax Template Editor
        </h1>

        <div class="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btn-undo" title="Deshacer (Ctrl+Z)" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-redo" title="Rehacer (Ctrl+Y)" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6"/><path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" id="btn-grid" title="Mostrar cuadricula (G)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-snap" title="Snap to grid (S)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-rulers" title="Reglas y guias (R)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/><path d="M7 3v3M11 3v2M15 3v3M19 3v2M3 7h3M3 11h2M3 15h3M3 19h2"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-snap-guides" title="Snap a guias (Shift+S)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12h16M12 4v16" stroke="#ef4444"/><circle cx="12" cy="12" r="2"/>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" id="btn-bring-front" title="Traer al frente">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="8" y="8" width="12" height="12" rx="2"/><path d="M4 16V6a2 2 0 012-2h10"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-send-back" title="Enviar atras">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="12" height="12" rx="2"/><path d="M20 8v10a2 2 0 01-2 2H8"/>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" id="btn-duplicate" title="Duplicar (Ctrl+D)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-copy-format" title="Copiar formato (Ctrl+Shift+C)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-paste-format" title="Pegar formato (Ctrl+Shift+V)" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <button class="toolbar-btn" id="btn-delete" title="Eliminar (Supr)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>

            <div class="toolbar-divider"></div>

            <!-- Group buttons -->
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btn-group" title="Agrupar (Ctrl+G)" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><path d="M10 12h4M12 10v4" stroke="#8b5cf6" stroke-width="2"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="btn-ungroup" title="Desagrupar (Ctrl+Shift+G)" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><path d="M9 12h6" stroke="#ef4444" stroke-width="2"/>
                    </svg>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Align dropdown -->
            <div class="align-dropdown" id="align-dropdown">
                <button class="toolbar-btn" id="btn-align" title="Alinear elementos">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>
                    </svg>
                </button>
                <div class="align-dropdown-content">
                    <!-- Alineación al Canvas -->
                    <div class="align-section">
                        <div class="align-section-title">Alinear al Canvas</div>
                        <div class="align-buttons">
                            <button class="align-btn align-canvas-btn" id="align-canvas-left" title="Izquierda" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="4" y2="20"/><rect x="8" y="6" width="12" height="4"/><rect x="8" y="14" width="8" height="4"/></svg>
                            </button>
                            <button class="align-btn align-canvas-btn" id="align-canvas-center-h" title="Centro Horizontal" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="4" x2="12" y2="20"/><rect x="6" y="6" width="12" height="4"/><rect x="8" y="14" width="8" height="4"/></svg>
                            </button>
                            <button class="align-btn align-canvas-btn" id="align-canvas-right" title="Derecha" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="20" y1="4" x2="20" y2="20"/><rect x="4" y="6" width="12" height="4"/><rect x="8" y="14" width="8" height="4"/></svg>
                            </button>
                            <button class="align-btn align-canvas-btn" id="align-canvas-top" title="Arriba" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="20" y2="4"/><rect x="6" y="8" width="4" height="12"/><rect x="14" y="8" width="4" height="8"/></svg>
                            </button>
                            <button class="align-btn align-canvas-btn" id="align-canvas-center-v" title="Centro Vertical" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="12" x2="20" y2="12"/><rect x="6" y="6" width="4" height="12"/><rect x="14" y="8" width="4" height="8"/></svg>
                            </button>
                            <button class="align-btn align-canvas-btn" id="align-canvas-bottom" title="Abajo" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="20"/><rect x="6" y="4" width="4" height="12"/><rect x="14" y="8" width="4" height="8"/></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Alineación entre Elementos -->
                    <div class="align-section">
                        <div class="align-section-title">Alinear entre si (2+ elem.)</div>
                        <div class="align-buttons">
                            <button class="align-btn align-elements-btn" id="align-elem-left" title="Izquierda" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="4" y2="20"/><rect x="8" y="6" width="12" height="4"/><rect x="8" y="14" width="8" height="4"/></svg>
                            </button>
                            <button class="align-btn align-elements-btn" id="align-elem-center-h" title="Centro Horizontal" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="4" x2="12" y2="20"/><rect x="6" y="6" width="12" height="4"/><rect x="8" y="14" width="8" height="4"/></svg>
                            </button>
                            <button class="align-btn align-elements-btn" id="align-elem-right" title="Derecha" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="20" y1="4" x2="20" y2="20"/><rect x="4" y="6" width="12" height="4"/><rect x="8" y="14" width="8" height="4"/></svg>
                            </button>
                            <button class="align-btn align-elements-btn" id="align-elem-top" title="Arriba" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="20" y2="4"/><rect x="6" y="8" width="4" height="12"/><rect x="14" y="8" width="4" height="8"/></svg>
                            </button>
                            <button class="align-btn align-elements-btn" id="align-elem-center-v" title="Centro Vertical" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="12" x2="20" y2="12"/><rect x="6" y="6" width="4" height="12"/><rect x="14" y="8" width="4" height="8"/></svg>
                            </button>
                            <button class="align-btn align-elements-btn" id="align-elem-bottom" title="Abajo" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="20" x2="20" y2="20"/><rect x="6" y="4" width="4" height="12"/><rect x="14" y="8" width="4" height="8"/></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Distribución -->
                    <div class="align-section">
                        <div class="align-section-title">Distribuir (3+ elem.)</div>
                        <div class="align-buttons">
                            <button class="align-btn distribute-btn" id="distribute-h" title="Distribuir Horizontalmente" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="5" width="3" height="14"/><rect x="10.5" y="5" width="3" height="14"/><rect x="17" y="5" width="3" height="14"/></svg>
                            </button>
                            <button class="align-btn distribute-btn" id="distribute-v" title="Distribuir Verticalmente" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="4" width="14" height="3"/><rect x="5" y="10.5" width="14" height="3"/><rect x="5" y="17" width="14" height="3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="header-actions">
            <button class="btn btn-outline" id="btn-shortcuts" title="Atajos de teclado">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M6 16h12"/>
                </svg>
            </button>
            <button class="btn btn-outline" id="btn-preview-mode" title="Modo Preview con datos simulados">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                </svg>
                Preview
            </button>
            <button class="btn btn-secondary" id="btn-load-bg">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
                </svg>
                Fondo
            </button>
            <button class="btn btn-secondary" id="btn-new">Nuevo</button>
            <button class="btn btn-outline" id="btn-clear-storage" title="Limpiar localStorage (si hay problemas de espacio)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
            </button>
            <button class="btn btn-secondary" id="btn-load">Cargar</button>
            <button class="btn btn-secondary" id="btn-save">Guardar</button>
            <button class="btn btn-success" id="btn-export">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                </svg>
                Exportar JSON
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Elements -->
        <aside class="left-panel">
            <div class="panel-header">Elementos</div>
            <div class="elements-list">
                <div class="element-category">
                    <div class="element-category-title">Textos Dinamicos</div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{nombre_completo}}" data-label="Nombre Completo">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Nombre Completo
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{dni}}" data-label="DNI">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10M7 12h6"/></svg>
                        DNI
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{nombre_curso}}" data-label="Nombre del Curso">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                        Nombre Curso
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{fecha}}" data-label="Fecha">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                        Fecha
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{fecha_curso}}" data-label="Periodo del Curso">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18M7 14h4M13 14h4"/></svg>
                        Periodo Curso
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{fecha_inicio}}" data-label="Fecha Inicio">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 14l4 4 4-4"/></svg>
                        Fecha Inicio
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{fecha_fin}}" data-label="Fecha Fin">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 18l4-4 4 4"/></svg>
                        Fecha Fin
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{lugar_fecha}}" data-label="Lugar y Fecha">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        Lugar y Fecha
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{ciudad}}" data-label="Ciudad">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4"/><path d="M9 9v.01M9 12v.01M9 15v.01M9 18v.01"/></svg>
                        Ciudad
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{carga_horaria}}" data-label="Carga Horaria">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        Carga Horaria
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{codigo_validacion}}" data-label="Codigo Validacion">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        Codigo Validacion
                    </div>
                </div>

                <div class="element-category">
                    <div class="element-category-title">Titulos</div>
                    <div class="element-item" draggable="true" data-type="title" data-text="CERTIFICADO" data-label="Titulo: Certificado">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg>
                        Certificado
                    </div>
                    <div class="element-item" draggable="true" data-type="title" data-text="DIPLOMA" data-label="Titulo: Diploma">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg>
                        Diploma
                    </div>
                    <div class="element-item" draggable="true" data-type="title" data-text="CONSTANCIA" data-label="Titulo: Constancia">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg>
                        Constancia
                    </div>
                    <div class="element-item" draggable="true" data-type="text-custom" data-label="Texto Libre">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                        Texto Libre
                    </div>
                    <div class="element-item" draggable="true" data-type="paragraph" data-label="Parrafo con Variables" data-text="{{lugar_fecha}}, se certifica que **{{nombre_completo}}** con DNI **{{dni}}** ha completado y aprobado satisfactoriamente el curso **{{nombre_curso}}** con una carga horaria de {{carga_horaria}} horas.">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                        Parrafo (con variables)
                    </div>
                </div>

                <div class="element-category">
                    <div class="element-category-title">Firmantes</div>
                    <div class="element-item" draggable="true" data-type="image" data-variable="{{firma_1}}" data-label="Firma 1">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                        Firma 1
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{firmante_1_nombre}}" data-label="Nombre Firmante 1">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Nombre Firmante 1
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{firmante_1_cargo}}" data-label="Cargo Firmante 1">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
                        Cargo Firmante 1
                    </div>
                    <div class="element-item" draggable="true" data-type="image" data-variable="{{firma_2}}" data-label="Firma 2">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                        Firma 2
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{firmante_2_nombre}}" data-label="Nombre Firmante 2">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Nombre Firmante 2
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{firmante_2_cargo}}" data-label="Cargo Firmante 2">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
                        Cargo Firmante 2
                    </div>
                </div>

                <div class="element-category">
                    <div class="element-category-title">Imagenes</div>
                    <div class="element-item" draggable="true" data-type="image" data-variable="{{logo_1}}" data-label="Logo Principal">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        Logo Principal
                    </div>
                    <div class="element-item" draggable="true" data-type="image" data-variable="{{logo_2}}" data-label="Logo Secundario">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        Logo Secundario
                    </div>
                    <div class="element-item" draggable="true" data-type="image" data-variable="{{logo_verumax}}" data-label="Logo Verumax">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>
                        Logo Verumax
                    </div>
                    <div class="element-item" draggable="true" data-type="image-custom" data-variable="" data-label="Imagen Personalizada">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/><path d="M14 14l3-3 4 4"/></svg>
                        Imagen Personalizada
                    </div>
                    <div class="element-item" draggable="true" data-type="qr" data-variable="{{qr}}" data-label="Codigo QR">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        Codigo QR
                    </div>
                </div>

                <div class="element-category">
                    <div class="element-category-title">Institucion</div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{nombre_institucion}}" data-label="Nombre Institucion">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4"/></svg>
                        Nombre Institucion
                    </div>
                    <div class="element-item" draggable="true" data-type="text" data-variable="{{descripcion}}" data-label="Descripcion/Cuerpo">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                        Descripcion
                    </div>
                </div>

                <div class="element-category">
                    <div class="element-category-title">Formas y Lineas</div>
                    <div class="element-item" draggable="true" data-type="line" data-orientation="horizontal" data-label="Linea Horizontal">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/></svg>
                        Linea Horizontal
                    </div>
                    <div class="element-item" draggable="true" data-type="line" data-orientation="vertical" data-label="Linea Vertical">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="3" x2="12" y2="21"/></svg>
                        Linea Vertical
                    </div>
                    <div class="element-item" draggable="true" data-type="line-firma" data-label="Linea de Firma">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="18" x2="21" y2="18"/><path d="M7 14c2-2 4-4 6-2s4 0 6-2"/></svg>
                        Linea de Firma
                    </div>
                    <div class="element-item" draggable="true" data-type="separator" data-label="Separador Decorativo">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><line x1="3" y1="12" x2="9" y2="12"/><line x1="15" y1="12" x2="21" y2="12"/></svg>
                        Separador
                    </div>
                </div>

                <div class="element-category">
                    <div class="element-category-title">Sellos</div>
                    <div class="element-item" draggable="true" data-type="stamp" data-label="Sello Fecha" data-text="{{fecha_sello}}">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="1"/><path d="M3 10h18"/><path d="M3 14h18"/><path d="M8 6V4"/><path d="M16 6V4"/></svg>
                        Sello Fecha
                    </div>
                    <div class="element-item" draggable="true" data-type="stamp" data-label="Sello Emitido" data-text="EMITIDO">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="1"/><path d="M7 12h10"/><path d="M8 6V4"/><path d="M16 6V4"/></svg>
                        Sello Emitido
                    </div>
                    <div class="element-item" draggable="true" data-type="stamp" data-label="Sello Personalizado" data-text="CERTIFICADO">
                        <svg class="element-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="1"/><path d="M8 6V4"/><path d="M16 6V4"/><circle cx="12" cy="12" r="2"/></svg>
                        Sello Personalizado
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas -->
        <main class="canvas-container" id="canvas-container">
            <!-- Viewport para zoom y pan -->
            <div class="canvas-viewport" id="canvas-viewport">
                <div class="rulers-container" id="rulers-container" style="display: none;">
                    <!-- Fila superior: esquina + regla horizontal -->
                    <div class="ruler-horizontal-wrapper">
                        <div class="ruler-corner" id="ruler-corner" title="Click para limpiar guias">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 12h16M12 4v16" stroke="currentColor"/>
                            </svg>
                        </div>
                        <div class="ruler-horizontal" id="ruler-horizontal"></div>
                    </div>
                    <!-- Fila inferior: regla vertical + canvas -->
                    <div class="ruler-vertical-wrapper">
                        <div class="ruler-vertical" id="ruler-vertical"></div>
                        <div class="canvas-wrapper" id="canvas-wrapper-with-rulers">
                            <div class="canvas landscape" id="canvas">
                                <svg class="canvas-grid" id="canvas-grid">
                                    <defs>
                                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#ccc" stroke-width="0.5"/>
                                        </pattern>
                                    </defs>
                                    <rect width="100%" height="100%" fill="url(#grid)"/>
                                </svg>
                                <!-- Guides container -->
                                <div class="guides-container" id="guides-container"></div>
                                <!-- Canvas elements will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Canvas sin reglas (default) -->
                <div class="canvas-wrapper" id="canvas-wrapper-no-rulers">
                    <div class="canvas landscape" id="canvas-no-rulers">
                        <svg class="canvas-grid" id="canvas-grid-no-rulers">
                            <defs>
                                <pattern id="grid2" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#ccc" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid2)"/>
                        </svg>
                        <!-- Guides container -->
                        <div class="guides-container" id="guides-container-no-rulers"></div>
                        <!-- Canvas elements will be added here -->
                    </div>
                </div>
            </div>

            <!-- Zoom controls -->
            <div class="zoom-indicator" id="zoom-indicator">
                <button id="zoom-out" title="Alejar (-)">−</button>
                <span class="zoom-level" id="zoom-level">100%</span>
                <button id="zoom-in" title="Acercar (+)">+</button>
                <button id="zoom-reset" title="Restablecer (0)" style="margin-left: 0.5rem; font-size: 0.7rem;">1:1</button>
                <button id="zoom-fit" title="Ajustar a ventana (F)" style="font-size: 0.7rem;">Fit</button>
            </div>
        </main>

        <!-- Right Panel - Properties -->
        <aside class="right-panel">
            <div class="panel-header">Propiedades</div>
            <div class="properties-content" id="properties-panel">
                <div class="empty-state" id="no-selection">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    <p>Selecciona un elemento para editar sus propiedades</p>
                </div>

                <div id="element-properties" style="display: none;">
                    <div class="property-group">
                        <div class="property-group-title">Posicion</div>
                        <div class="property-row-split">
                            <div class="property-unit">
                                <label>X:</label>
                                <input type="number" class="property-input property-input-small" id="prop-x" step="1">
                                <span>px</span>
                            </div>
                            <div class="property-unit">
                                <label>Y:</label>
                                <input type="number" class="property-input property-input-small" id="prop-y" step="1">
                                <span>px</span>
                            </div>
                        </div>
                        <div class="property-row-split">
                            <div class="property-unit">
                                <label>W:</label>
                                <input type="number" class="property-input property-input-small" id="prop-width" step="1">
                                <span>px</span>
                            </div>
                            <div class="property-unit">
                                <label>H:</label>
                                <input type="number" class="property-input property-input-small" id="prop-height" step="1">
                                <span>px</span>
                            </div>
                        </div>
                    </div>

                    <div class="property-group" id="text-properties">
                        <div class="property-group-title">Texto</div>

                        <!-- Contenido simple para text/title/text-custom -->
                        <div class="property-row" id="simple-text-container" style="flex-direction: column; align-items: stretch;">
                            <label class="property-label" style="width: 100%; margin-bottom: 0.25rem;">Contenido:</label>
                            <div class="text-format-toolbar">
                                <button type="button" class="text-format-btn bold" onclick="insertFormat('**')" title="Negrita (Ctrl+B)">B</button>
                                <button type="button" class="text-format-btn italic" onclick="insertFormat('*')" title="Italica (Ctrl+I)">I</button>
                                <span style="font-size: 0.65rem; color: var(--gray-400); margin-left: auto;">**negrita** *italica*</span>
                            </div>
                            <textarea class="property-input" id="prop-text" rows="4"></textarea>
                            <details style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--gray-500);">
                                <summary style="cursor: pointer;">Variables disponibles</summary>
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 4px; font-family: monospace;">
                                    {{nombre_completo}}<br>
                                    {{dni}}<br>
                                    {{nombre_curso}}<br>
                                    {{fecha}}<br>
                                    {{carga_horaria}}<br>
                                    {{codigo_validacion}}<br>
                                    {{nombre_institucion}}<br>
                                    {{firmante_1_nombre}}<br>
                                    {{firmante_1_cargo}}<br>
                                    {{firmante_2_nombre}}<br>
                                    {{firmante_2_cargo}}
                                </div>
                            </details>
                            <!-- Campo text_key para internacionalización -->
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200);">
                                <label class="property-label" style="width: 100%; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                    Clave de traducción:
                                    <span style="font-size: 0.6rem; color: var(--gray-400); font-weight: normal;">(opcional, para multiidioma)</span>
                                </label>
                                <select class="property-select" id="prop-text-key" style="width: 100%;">
                                    <option value="">-- Sin traducción (usar texto literal) --</option>
                                    <optgroup label="Títulos principales">
                                        <option value="certificatum.template.titulo_certificado">CERTIFICADO / CERTIFICADO</option>
                                        <option value="certificatum.template.titulo_constancia">CONSTANCIA / DECLARAÇÃO</option>
                                    </optgroup>
                                    <optgroup label="Subtítulos">
                                        <option value="certificatum.template.subtitulo_aprobacion">Certificado de Aprobación / Certificado de Conclusão</option>
                                        <option value="certificatum.template.subtitulo_finalizacion">Certificado de Finalización / Certificado de Conclusão</option>
                                        <option value="certificatum.template.subtitulo_docente">Certificado de Formación / Certificado de Formação</option>
                                    </optgroup>
                                    <optgroup label="Textos introductorios">
                                        <option value="certificatum.template.otorgamiento">Por el presente se otorga... / Pelo presente, outorga-se...</option>
                                    </optgroup>
                                </select>
                                <div style="font-size: 0.65rem; color: var(--gray-500); margin-top: 0.25rem;">
                                    Si se selecciona una clave, el texto se traducirá según el idioma del usuario.
                                </div>
                            </div>
                        </div>

                        <!-- Contenido con tabs para PARAGRAPH (aprobacion/finalizacion/docente) -->
                        <div id="paragraph-text-container" style="display: none;">
                            <div class="paragraph-tabs" style="display: flex; gap: 0; margin-bottom: 0.5rem; border-bottom: 2px solid var(--gray-200);">
                                <button type="button" class="paragraph-tab active" id="tab-aprobacion" onclick="switchParagraphTab('aprobacion')" style="flex: 1; padding: 0.5rem; border: none; background: transparent; cursor: pointer; font-size: 0.7rem; font-weight: 500; color: var(--gray-600); border-bottom: 2px solid transparent; margin-bottom: -2px;">
                                    Aprobación
                                </button>
                                <button type="button" class="paragraph-tab" id="tab-finalizacion" onclick="switchParagraphTab('finalizacion')" style="flex: 1; padding: 0.5rem; border: none; background: transparent; cursor: pointer; font-size: 0.7rem; font-weight: 500; color: var(--gray-600); border-bottom: 2px solid transparent; margin-bottom: -2px;">
                                    Finalización
                                </button>
                                <button type="button" class="paragraph-tab" id="tab-docente" onclick="switchParagraphTab('docente')" style="flex: 1; padding: 0.5rem; border: none; background: transparent; cursor: pointer; font-size: 0.7rem; font-weight: 500; color: var(--gray-600); border-bottom: 2px solid transparent; margin-bottom: -2px;">
                                    Docente
                                </button>
                            </div>

                            <!-- Panel Aprobación (estudiantes aprobados) -->
                            <div id="panel-aprobacion" class="paragraph-panel">
                                <div class="text-format-toolbar">
                                    <button type="button" class="text-format-btn bold" onclick="insertFormatInTextarea('prop-text-aprobacion', '**')" title="Negrita">B</button>
                                    <button type="button" class="text-format-btn italic" onclick="insertFormatInTextarea('prop-text-aprobacion', '*')" title="Italica">I</button>
                                    <span style="font-size: 0.65rem; color: var(--gray-400); margin-left: auto;">**negrita** *italica*</span>
                                </div>
                                <textarea class="property-input" id="prop-text-aprobacion" rows="4" placeholder="Texto para certificados de aprobación..."></textarea>
                                <div style="margin-top: 0.5rem;">
                                    <label style="font-size: 0.7rem; color: var(--gray-600);">Clave traducción (opcional):</label>
                                    <select class="property-select" id="prop-text-key-aprobacion" style="width: 100%; font-size: 0.75rem;">
                                        <option value="">-- Sin traducción --</option>
                                        <optgroup label="Subtítulos">
                                            <option value="certificatum.template.subtitulo_aprobacion">Certificado de Aprobación</option>
                                            <option value="certificatum.template.otorgamiento">Por el presente se otorga...</option>
                                        </optgroup>
                                        <optgroup label="Párrafos completos">
                                            <option value="certificatum.template.parrafo_aprobacion">Párrafo estándar aprobación</option>
                                            <option value="certificatum.template.parrafo_aprobacion_v2">Párrafo con período del curso</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <details style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--gray-500);">
                                    <summary style="cursor: pointer;">Variables para estudiantes</summary>
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 4px; font-family: monospace;">
                                        {{nombre_completo}}<br>
                                        {{dni}}<br>
                                        {{nombre_curso}}<br>
                                        {{lugar_fecha}} <span style="color:#666;font-size:0.65rem;">← con/sin ciudad</span><br>
                                        {{ciudad}}<br>
                                        {{fecha}}<br>
                                        {{fecha_curso}}<br>
                                        {{fecha_inicio}}<br>
                                        {{fecha_fin}}<br>
                                        {{carga_horaria}}<br>
                                        {{codigo_validacion}}<br>
                                        {{nombre_institucion}}
                                    </div>
                                </details>
                            </div>

                            <!-- Panel Finalización (estudiantes finalizados) -->
                            <div id="panel-finalizacion" class="paragraph-panel" style="display: none;">
                                <div class="text-format-toolbar">
                                    <button type="button" class="text-format-btn bold" onclick="insertFormatInTextarea('prop-text-finalizacion', '**')" title="Negrita">B</button>
                                    <button type="button" class="text-format-btn italic" onclick="insertFormatInTextarea('prop-text-finalizacion', '*')" title="Italica">I</button>
                                    <span style="font-size: 0.65rem; color: var(--gray-400); margin-left: auto;">**negrita** *italica*</span>
                                </div>
                                <textarea class="property-input" id="prop-text-finalizacion" rows="4" placeholder="Texto para certificados de finalización..."></textarea>
                                <div style="margin-top: 0.5rem;">
                                    <label style="font-size: 0.7rem; color: var(--gray-600);">Clave traducción (opcional):</label>
                                    <select class="property-select" id="prop-text-key-finalizacion" style="width: 100%; font-size: 0.75rem;">
                                        <option value="">-- Sin traducción --</option>
                                        <optgroup label="Subtítulos">
                                            <option value="certificatum.template.subtitulo_finalizacion">Certificado de Finalización</option>
                                            <option value="certificatum.template.otorgamiento">Por el presente se otorga...</option>
                                        </optgroup>
                                        <optgroup label="Párrafos completos">
                                            <option value="certificatum.template.parrafo_finalizacion">Párrafo estándar finalización</option>
                                            <option value="certificatum.template.parrafo_finalizacion_v2">Párrafo con período del curso</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <details style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--gray-500);">
                                    <summary style="cursor: pointer;">Variables para estudiantes</summary>
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 4px; font-family: monospace;">
                                        {{nombre_completo}}<br>
                                        {{dni}}<br>
                                        {{nombre_curso}}<br>
                                        {{lugar_fecha}} <span style="color:#666;font-size:0.65rem;">← con/sin ciudad</span><br>
                                        {{ciudad}}<br>
                                        {{fecha}}<br>
                                        {{fecha_curso}}<br>
                                        {{fecha_inicio}}<br>
                                        {{fecha_fin}}<br>
                                        {{carga_horaria}}<br>
                                        {{codigo_validacion}}<br>
                                        {{nombre_institucion}}
                                    </div>
                                </details>
                            </div>

                            <!-- Panel Docente -->
                            <div id="panel-docente" class="paragraph-panel" style="display: none;">
                                <div class="text-format-toolbar">
                                    <button type="button" class="text-format-btn bold" onclick="insertFormatInTextarea('prop-text-docente', '**')" title="Negrita">B</button>
                                    <button type="button" class="text-format-btn italic" onclick="insertFormatInTextarea('prop-text-docente', '*')" title="Italica">I</button>
                                    <span style="font-size: 0.65rem; color: var(--gray-400); margin-left: auto;">**negrita** *italica*</span>
                                </div>
                                <textarea class="property-input" id="prop-text-docente" rows="4" placeholder="Texto para certificados de docentes/formadores..."></textarea>
                                <div style="margin-top: 0.5rem;">
                                    <label style="font-size: 0.7rem; color: var(--gray-600);">Clave traducción (opcional):</label>
                                    <select class="property-select" id="prop-text-key-docente" style="width: 100%; font-size: 0.75rem;">
                                        <option value="">-- Sin traducción --</option>
                                        <optgroup label="Subtítulos">
                                            <option value="certificatum.template.subtitulo_docente">Certificado de Formación</option>
                                            <option value="certificatum.template.otorgamiento">Por el presente se otorga...</option>
                                        </optgroup>
                                        <optgroup label="Párrafos completos">
                                            <option value="certificatum.template.parrafo_docente">Párrafo estándar docente</option>
                                            <option value="certificatum.template.parrafo_docente_v2">Párrafo docente (con período)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <details style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--gray-500);">
                                    <summary style="cursor: pointer;">Variables para docentes</summary>
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 4px; font-family: monospace;">
                                        {{nombre_completo}}<br>
                                        {{dni}}<br>
                                        {{nombre_curso}}<br>
                                        {{lugar_fecha}} <span style="color:#666;font-size:0.65rem;">← con/sin ciudad</span><br>
                                        {{ciudad}}<br>
                                        {{fecha}}<br>
                                        {{fecha_curso}}<br>
                                        {{fecha_inicio}}<br>
                                        {{fecha_fin}}<br>
                                        {{rol}}<br>
                                        {{codigo_validacion}}<br>
                                        {{nombre_institucion}}
                                    </div>
                                </details>
                            </div>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Fuente:</label>
                            <select class="property-select" id="prop-font">
                                <optgroup label="--- TITULOS ELEGANTES ---">
                                    <option value="Antic Didone">Antic Didone (Certificados)</option>
                                    <option value="Cormorant Garamond">Cormorant Garamond</option>
                                    <option value="Playfair Display">Playfair Display</option>
                                    <option value="Cinzel">Cinzel</option>
                                    <option value="EB Garamond">EB Garamond</option>
                                    <option value="Libre Baskerville">Libre Baskerville</option>
                                    <option value="Crimson Text">Crimson Text</option>
                                </optgroup>
                                <optgroup label="--- NOMBRES CURSIVOS ---">
                                    <option value="Great Vibes">Great Vibes (Nombres)</option>
                                    <option value="Tangerine">Tangerine</option>
                                    <option value="Alex Brush">Alex Brush</option>
                                    <option value="Allura">Allura</option>
                                    <option value="Parisienne">Parisienne</option>
                                    <option value="Pinyon Script">Pinyon Script</option>
                                    <option value="Dancing Script">Dancing Script</option>
                                </optgroup>
                                <optgroup label="--- SANS SERIF ---">
                                    <option value="Arial">Arial</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Roboto">Roboto</option>
                                    <option value="Open Sans">Open Sans</option>
                                    <option value="Montserrat">Montserrat</option>
                                    <option value="Inter">Inter</option>
                                </optgroup>
                                <optgroup label="--- SERIF CLASICAS ---">
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Merriweather">Merriweather</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Tamano:</label>
                            <input type="number" class="property-input property-input-small" id="prop-size" min="8" max="200" step="1">
                            <span>px</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Color:</label>
                            <input type="color" class="property-color" id="prop-color" value="#333333">
                            <input type="text" class="property-input" id="prop-color-text" value="#333333" style="width: 80px;">
                        </div>
                        <div class="property-row">
                            <label class="property-label">Alinear:</label>
                            <select class="property-select" id="prop-align">
                                <option value="left">Izquierda</option>
                                <option value="center">Centro</option>
                                <option value="right">Derecha</option>
                            </select>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Estilo:</label>
                            <select class="property-select" id="prop-style">
                                <option value="normal">Normal</option>
                                <option value="bold">Negrita</option>
                                <option value="italic">Italica</option>
                                <option value="bold italic">Negrita Italica</option>
                            </select>
                        </div>
                    </div>

                    <div class="property-group" id="image-properties" style="display: none;">
                        <div class="property-group-title">Imagen</div>
                        <div class="property-row" id="prop-variable-row">
                            <label class="property-label">Variable:</label>
                            <input type="text" class="property-input" id="prop-variable" readonly>
                        </div>
                        <div class="property-row" id="prop-src-row" style="display: none;">
                            <label class="property-label">Ruta:</label>
                            <input type="text" class="property-input" id="prop-src" placeholder="assets/templates/certificados/sajur/imagen.png">
                        </div>
                        <div id="prop-src-help" style="display: none; font-size: 11px; color: #666; padding: 4px 8px; background: #f5f5f5; border-radius: 4px; margin-top: 4px;">
                            📁 Ruta relativa desde /appVerumax/<br>
                            Ej: assets/templates/certificados/[institucion]/[archivo.png]
                        </div>
                        <div class="property-row" id="prop-img-rotation-row" style="display: none;">
                            <label class="property-label">Rotación:</label>
                            <input type="number" class="property-input property-input-small" id="prop-img-rotation" min="-180" max="180" step="1" value="0">
                            <span>°</span>
                        </div>
                        <div class="property-row" id="prop-img-opacity-row" style="display: none;">
                            <label class="property-label">Opacidad:</label>
                            <input type="range" id="prop-img-opacity" min="0.1" max="1" step="0.05" value="1" style="flex: 1;">
                            <span id="prop-img-opacity-value">100%</span>
                        </div>
                    </div>

                    <div class="property-group" id="line-properties" style="display: none;">
                        <div class="property-group-title">Linea</div>
                        <div class="property-row">
                            <label class="property-label">Color:</label>
                            <input type="color" class="property-color" id="prop-line-color" value="#333333">
                            <input type="text" class="property-input" id="prop-line-color-text" value="#333333" style="width: 80px;">
                        </div>
                        <div class="property-row">
                            <label class="property-label">Grosor:</label>
                            <input type="number" class="property-input property-input-small" id="prop-line-thickness" min="1" max="20" step="1" value="2">
                            <span>px</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Estilo:</label>
                            <select class="property-select" id="prop-line-style">
                                <option value="solid">Solido</option>
                                <option value="dashed">Guiones</option>
                                <option value="dotted">Puntos</option>
                            </select>
                        </div>
                    </div>

                    <div class="property-group" id="separator-properties" style="display: none;">
                        <div class="property-group-title">Separador</div>
                        <div class="property-row">
                            <label class="property-label">Color:</label>
                            <input type="color" class="property-color" id="prop-sep-color" value="#666666">
                            <input type="text" class="property-input" id="prop-sep-color-text" value="#666666" style="width: 80px;">
                        </div>
                        <div class="property-row">
                            <label class="property-label">Estilo:</label>
                            <select class="property-select" id="prop-sep-style">
                                <option value="dot">Punto</option>
                                <option value="diamond">Diamante</option>
                                <option value="double">Doble Punto</option>
                            </select>
                        </div>
                    </div>

                    <div class="property-group" id="stamp-properties" style="display: none;">
                        <div class="property-group-title">Sello</div>
                        <div class="property-row">
                            <label class="property-label">Texto:</label>
                            <input type="text" class="property-input" id="prop-stamp-text" placeholder="{{fecha_sello}}">
                        </div>
                        <div class="property-row">
                            <label class="property-label">Color:</label>
                            <input type="color" class="property-color" id="prop-stamp-color" value="#1e40af">
                            <input type="text" class="property-input" id="prop-stamp-color-text" value="#1e40af" style="width: 80px;">
                        </div>
                        <div class="property-row">
                            <label class="property-label">Tamaño:</label>
                            <input type="number" class="property-input property-input-small" id="prop-stamp-size" min="8" max="36" step="1" value="12">
                            <span>px</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Rotación:</label>
                            <input type="number" class="property-input property-input-small" id="prop-stamp-rotation" min="-45" max="45" step="1" value="-3">
                            <span>°</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Opacidad:</label>
                            <input type="range" id="prop-stamp-opacity" min="0.3" max="1" step="0.05" value="0.85" style="flex: 1;">
                            <span id="prop-stamp-opacity-value">85%</span>
                        </div>
                        <div class="property-row">
                            <label class="property-label">Borde:</label>
                            <input type="number" class="property-input property-input-small" id="prop-stamp-border" min="0" max="5" step="1" value="2">
                            <span>px (0 = sin borde)</span>
                        </div>
                    </div>

                    <!-- Botón Eliminar -->
                    <div class="property-group" style="margin-top: 1rem; border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                        <button id="btn-delete-element" onclick="deleteSelected()"
                                style="width: 100%; padding: 0.625rem; background: #dc2626; color: white; border: none; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                            </svg>
                            Eliminar elemento
                        </button>
                    </div>
                </div>
            </div>

            <!-- Layers -->
            <div class="layers-panel">
                <div class="panel-header">Capas</div>
                <div class="layers-list" id="layers-list">
                    <!-- Layer items will be added here -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="status-info">Listo | A4 Landscape (842 x 595 px)</span>
        <span id="status-zoom">100%</span>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-new">
        <div class="modal">
            <h2>Nuevo Template</h2>
            <div class="property-group">
                <div class="property-row">
                    <label class="property-label">Nombre:</label>
                    <input type="text" class="property-input" id="new-name" placeholder="Mi Template">
                </div>
                <div class="property-row">
                    <label class="property-label">Slug:</label>
                    <input type="text" class="property-input" id="new-slug" placeholder="mi_template" pattern="[a-z0-9_-]+" style="font-family: monospace;">
                    <small style="color: var(--gray-500); font-size: 0.7rem; display: block; margin-top: 2px;">
                        Identificador unico (sin espacios). El fondo se guardara en esta carpeta.
                    </small>
                </div>
                <div class="property-row">
                    <label class="property-label">Orientacion:</label>
                    <select class="property-select" id="new-orientation">
                        <option value="landscape">Horizontal (Landscape)</option>
                        <option value="portrait">Vertical (Portrait)</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('modal-new')">Cancelar</button>
                <button class="btn btn-primary" onclick="createNewTemplate()">Crear</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-export">
        <div class="modal">
            <h2>Exportar config.json</h2>
            <textarea id="export-json" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; padding: 1rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('modal-export')">Cerrar</button>
                <button class="btn btn-primary" onclick="copyToClipboard()">Copiar</button>
                <button class="btn btn-success" onclick="downloadJSON()">Descargar</button>
            </div>
        </div>
    </div>

    <!-- Modal Simulacion Cliente -->
    <div class="modal-overlay" id="modal-preview">
        <div class="modal" style="max-width: 700px;">
            <h2>Simulacion de Cliente - Preview</h2>
            <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1rem;">
                Carga imagenes y datos de prueba para ver como quedaria el certificado.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <!-- Columna Izquierda: Imagenes -->
                <div>
                    <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--gray-700);">Imagenes</h3>

                    <div class="preview-upload-group">
                        <label>Logo Principal:</label>
                        <div class="preview-upload-box" id="preview-logo1-box" onclick="document.getElementById('file-logo1').click()">
                            <img id="preview-logo1-img" style="display:none; max-width:100%; max-height:60px;">
                            <span id="preview-logo1-text">Click para cargar</span>
                        </div>
                        <input type="file" id="file-logo1" accept="image/*" style="display:none;">
                    </div>

                    <div class="preview-upload-group">
                        <label>Logo Secundario:</label>
                        <div class="preview-upload-box" id="preview-logo2-box" onclick="document.getElementById('file-logo2').click()">
                            <img id="preview-logo2-img" style="display:none; max-width:100%; max-height:60px;">
                            <span id="preview-logo2-text">Click para cargar</span>
                        </div>
                        <input type="file" id="file-logo2" accept="image/*" style="display:none;">
                    </div>

                    <div class="preview-upload-group">
                        <label>Logo Verumax:</label>
                        <div class="preview-upload-box" id="preview-logo-verumax-box" onclick="document.getElementById('file-logo-verumax').click()">
                            <img id="preview-logo-verumax-img" style="display:none; max-width:100%; max-height:60px;">
                            <span id="preview-logo-verumax-text">Click para cargar</span>
                        </div>
                        <input type="file" id="file-logo-verumax" accept="image/*" style="display:none;">
                    </div>

                    <div class="preview-upload-group">
                        <label>Firma 1:</label>
                        <div class="preview-upload-box" id="preview-firma1-box" onclick="document.getElementById('file-firma1').click()">
                            <img id="preview-firma1-img" style="display:none; max-width:100%; max-height:50px;">
                            <span id="preview-firma1-text">Click para cargar</span>
                        </div>
                        <input type="file" id="file-firma1" accept="image/*" style="display:none;">
                    </div>

                    <div class="preview-upload-group">
                        <label>Firma 2:</label>
                        <div class="preview-upload-box" id="preview-firma2-box" onclick="document.getElementById('file-firma2').click()">
                            <img id="preview-firma2-img" style="display:none; max-width:100%; max-height:50px;">
                            <span id="preview-firma2-text">Click para cargar</span>
                        </div>
                        <input type="file" id="file-firma2" accept="image/*" style="display:none;">
                    </div>
                </div>

                <!-- Columna Derecha: Datos -->
                <div>
                    <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--gray-700);">Datos de Prueba</h3>

                    <div class="preview-field">
                        <label>Nombre Completo:</label>
                        <input type="text" id="sim-nombre" value="Juan Carlos Gonzalez" class="property-input">
                    </div>
                    <div class="preview-field">
                        <label>DNI:</label>
                        <input type="text" id="sim-dni" value="32.456.789" class="property-input">
                    </div>
                    <div class="preview-field">
                        <label>Nombre del Curso:</label>
                        <input type="text" id="sim-curso" value="Introduccion a la Justicia Restaurativa" class="property-input">
                    </div>
                    <div class="preview-field">
                        <label>Fecha:</label>
                        <input type="text" id="sim-fecha" value="26 de Diciembre de 2025" class="property-input">
                    </div>
                    <div class="preview-field">
                        <label>Carga Horaria:</label>
                        <input type="text" id="sim-horas" value="40" class="property-input">
                    </div>
                    <div class="preview-field">
                        <label>Codigo Validacion:</label>
                        <input type="text" id="sim-codigo" value="CERT-2025-ABC123" class="property-input">
                    </div>
                    <div class="preview-field">
                        <label>Nombre Institucion:</label>
                        <input type="text" id="sim-institucion" value="Sociedad Argentina de Justicia Restaurativa" class="property-input">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="preview-field">
                            <label>Firmante 1 Nombre:</label>
                            <input type="text" id="sim-firmante1-nombre" value="Dra. Diana Marquez" class="property-input">
                        </div>
                        <div class="preview-field">
                            <label>Firmante 1 Cargo:</label>
                            <input type="text" id="sim-firmante1-cargo" value="Presidenta" class="property-input">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="preview-field">
                            <label>Firmante 2 Nombre:</label>
                            <input type="text" id="sim-firmante2-nombre" value="Dr. Roberto Sanchez" class="property-input">
                        </div>
                        <div class="preview-field">
                            <label>Firmante 2 Cargo:</label>
                            <input type="text" id="sim-firmante2-cargo" value="Director Academico" class="property-input">
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin: 0;">Perfiles de Cliente</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline" onclick="saveClientProfile()" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Guardar Perfil
                        </button>
                        <button class="btn btn-outline" onclick="document.getElementById('file-client-profile').click()" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Cargar Perfil
                        </button>
                    </div>
                </div>
                <div id="saved-profiles-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    <!-- Saved profiles will appear here -->
                </div>
                <input type="file" id="file-client-profile" accept=".json" style="display:none;">
            </div>

            <div class="modal-actions" style="margin-top: 1rem; justify-content: space-between;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">
                    <input type="checkbox" id="preview-enabled" checked>
                    Activar modo preview
                </label>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-preview')">Cerrar</button>
                    <button class="btn btn-primary" onclick="applyPreview()">Aplicar Preview</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shortcuts hint -->
    <div class="shortcuts-hint" id="shortcuts-panel">
        <div class="shortcut-row"><span>Deshacer</span><span class="shortcut-key">Ctrl+Z</span></div>
        <div class="shortcut-row"><span>Rehacer</span><span class="shortcut-key">Ctrl+Y</span></div>
        <div class="shortcut-row"><span>Eliminar</span><span class="shortcut-key">Supr</span></div>
        <div class="shortcut-row"><span>Duplicar</span><span class="shortcut-key">Ctrl+D</span></div>
        <div class="shortcut-row"><span>Guardar</span><span class="shortcut-key">Ctrl+S</span></div>
        <div style="border-top: 1px solid var(--gray-600); margin: 0.5rem 0;"></div>
        <div class="shortcut-row"><span>Copiar formato</span><span class="shortcut-key">Ctrl+Shift+C</span></div>
        <div class="shortcut-row"><span>Pegar formato</span><span class="shortcut-key">Ctrl+Shift+V</span></div>
        <div style="border-top: 1px solid var(--gray-600); margin: 0.5rem 0;"></div>
        <div class="shortcut-row"><span>Cuadricula</span><span class="shortcut-key">G</span></div>
        <div class="shortcut-row"><span>Snap grid</span><span class="shortcut-key">S</span></div>
        <div class="shortcut-row"><span>Reglas</span><span class="shortcut-key">R</span></div>
        <div class="shortcut-row"><span>Snap guias</span><span class="shortcut-key">Shift+S</span></div>
        <div style="border-top: 1px solid var(--gray-600); margin: 0.5rem 0;"></div>
        <div class="shortcut-row"><span>Zoom +</span><span class="shortcut-key">+ / Rueda</span></div>
        <div class="shortcut-row"><span>Zoom -</span><span class="shortcut-key">- / Rueda</span></div>
        <div class="shortcut-row"><span>Zoom 100%</span><span class="shortcut-key">0</span></div>
        <div class="shortcut-row"><span>Ajustar</span><span class="shortcut-key">F</span></div>
        <div class="shortcut-row"><span>Paneo</span><span class="shortcut-key">Boton medio</span></div>
        <div style="border-top: 1px solid var(--gray-600); margin: 0.5rem 0;"></div>
        <div class="shortcut-row"><span>Redim. proporcional</span><span class="shortcut-key">Shift+Drag</span></div>
        <div class="shortcut-row"><span>Mover 1px</span><span class="shortcut-key">Flechas</span></div>
        <div class="shortcut-row"><span>Mover 10px</span><span class="shortcut-key">Shift+Flechas</span></div>
        <div style="border-top: 1px solid var(--gray-600); margin: 0.5rem 0;"></div>
        <div class="shortcut-row"><span>Selec. multiple</span><span class="shortcut-key">Ctrl+Click</span></div>
        <div class="shortcut-row"><span>Agregar a selec.</span><span class="shortcut-key">Shift+Click</span></div>
        <div class="shortcut-row"><span>Ciclar superpuestos</span><span class="shortcut-key">Alt+Click</span></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Hidden file inputs -->
    <input type="file" id="file-bg" accept="image/*" style="display: none;">
    <input type="file" id="file-load" accept=".json" style="display: none;">

    <script>
        // ==========================================
        // STATE
        // ==========================================
        let state = {
            templateName: 'Nuevo Template',
            templateSlug: '',
            orientation: 'landscape',
            background: null,
            backgroundFilename: null,
            elements: [],
            selectedId: null,
            selectedIds: [], // Para selección múltiple
            history: [],
            historyIndex: -1,
            gridVisible: false,
            snapEnabled: false,
            snapSize: 20,
            nextId: 1,
            groups: {},
            nextGroupId: 1,
            rulersVisible: false,
            guides: [],
            snapToGuides: false,
            guideSnapDistance: 8,
            previewMode: false,
            previewData: {
                images: {
                    logo_1: null,
                    logo_2: null,
                    firma_1: null,
                    firma_2: null
                },
                values: {
                    nombre_completo: 'Juan Carlos Gonzalez',
                    dni: '32.456.789',
                    nombre_curso: 'Introduccion a la Justicia Restaurativa',
                    fecha: '26 de Diciembre de 2025',
                    carga_horaria: '40',
                    codigo_validacion: 'CERT-2025-ABC123',
                    nombre_institucion: 'Sociedad Argentina de Justicia Restaurativa',
                    firmante_1_nombre: 'Dra. Diana Marquez',
                    firmante_1_cargo: 'Presidenta',
                    firmante_2_nombre: 'Dr. Roberto Sanchez',
                    firmante_2_cargo: 'Director Academico'
                }
            },
            // Zoom y pan
            zoom: 1,
            zoomMin: 0.25,
            zoomMax: 3,
            zoomStep: 0.1,
            panX: 0,
            panY: 0,
            isPanning: false,
            // Copiar formato
            copiedFormat: null
        };

        // ==========================================
        // DOM ELEMENTS
        // ==========================================
        let canvas = document.getElementById('canvas-no-rulers');
        let canvasGrid = document.getElementById('canvas-grid-no-rulers');
        let guidesContainer = document.getElementById('guides-container-no-rulers');
        const canvasWithRulers = document.getElementById('canvas');
        const canvasGridWithRulers = document.getElementById('canvas-grid');
        const guidesContainerWithRulers = document.getElementById('guides-container');
        const rulersContainer = document.getElementById('rulers-container');
        const canvasWrapperNoRulers = document.getElementById('canvas-wrapper-no-rulers');
        const rulerHorizontal = document.getElementById('ruler-horizontal');
        const rulerVertical = document.getElementById('ruler-vertical');
        const rulerCorner = document.getElementById('ruler-corner');
        const canvasContainer = document.getElementById('canvas-container');
        const canvasViewport = document.getElementById('canvas-viewport');
        const zoomLevelDisplay = document.getElementById('zoom-level');
        const propertiesPanel = document.getElementById('properties-panel');
        const noSelection = document.getElementById('no-selection');
        const elementProperties = document.getElementById('element-properties');
        const textProperties = document.getElementById('text-properties');
        const imageProperties = document.getElementById('image-properties');
        const layersList = document.getElementById('layers-list');
        const statusInfo = document.getElementById('status-info');

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function init() {
            setupEventListeners();
            loadFromLocalStorage();
            saveState();
            updateUI();
            updateAlignButtons();
        }

        function setupEventListeners() {
            // Element drag from palette
            document.querySelectorAll('.element-item').forEach(el => {
                el.addEventListener('dragstart', handlePaletteDragStart);
            });

            // Canvas drop - Setup on BOTH canvases to handle ruler toggle
            const canvasNoRulers = document.getElementById('canvas-no-rulers');
            const canvasRulers = document.getElementById('canvas');

            [canvasNoRulers, canvasRulers].forEach(c => {
                c.addEventListener('dragover', e => e.preventDefault());
                c.addEventListener('drop', handleCanvasDrop);
                c.addEventListener('click', e => {
                    if (e.target === c) {
                        selectElement(null);
                    }
                });
            });

            // Property inputs
            document.getElementById('prop-x').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-y').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-width').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-height').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-text').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-text-key').addEventListener('change', updateElementFromProps);
            document.getElementById('prop-text-aprobacion').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-text-key-aprobacion').addEventListener('change', updateElementFromProps);
            document.getElementById('prop-text-finalizacion').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-text-key-finalizacion').addEventListener('change', updateElementFromProps);
            document.getElementById('prop-text-docente').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-text-key-docente').addEventListener('change', updateElementFromProps);
            document.getElementById('prop-font').addEventListener('change', updateElementFromProps);
            document.getElementById('prop-size').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-color').addEventListener('input', handleColorChange);
            document.getElementById('prop-color-text').addEventListener('input', handleColorTextChange);
            document.getElementById('prop-align').addEventListener('change', updateElementFromProps);
            document.getElementById('prop-style').addEventListener('change', updateElementFromProps);

            // Line property inputs
            document.getElementById('prop-line-color').addEventListener('input', handleLineColorChange);
            document.getElementById('prop-line-color-text').addEventListener('input', handleLineColorTextChange);
            document.getElementById('prop-line-thickness').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-line-style').addEventListener('change', updateElementFromProps);

            // Separator property inputs
            document.getElementById('prop-sep-color').addEventListener('input', handleSepColorChange);
            document.getElementById('prop-sep-color-text').addEventListener('input', handleSepColorTextChange);
            document.getElementById('prop-sep-style').addEventListener('change', updateElementFromProps);

            // Stamp property inputs
            document.getElementById('prop-stamp-text').addEventListener('input', updateStampFromProps);
            document.getElementById('prop-stamp-color').addEventListener('input', handleStampColorChange);
            document.getElementById('prop-stamp-color-text').addEventListener('input', handleStampColorTextChange);
            document.getElementById('prop-stamp-size').addEventListener('input', updateStampFromProps);
            document.getElementById('prop-stamp-rotation').addEventListener('input', updateStampFromProps);
            document.getElementById('prop-stamp-opacity').addEventListener('input', handleStampOpacityChange);
            document.getElementById('prop-stamp-border').addEventListener('input', updateStampFromProps);

            // Image custom property inputs
            document.getElementById('prop-src').addEventListener('input', updateElementFromProps);
            document.getElementById('prop-img-rotation').addEventListener('input', updateImageCustomFromProps);
            document.getElementById('prop-img-opacity').addEventListener('input', handleImageOpacityChange);

            // Toolbar buttons
            document.getElementById('btn-undo').addEventListener('click', undo);
            document.getElementById('btn-redo').addEventListener('click', redo);
            document.getElementById('btn-grid').addEventListener('click', toggleGrid);
            document.getElementById('btn-snap').addEventListener('click', toggleSnap);
            document.getElementById('btn-rulers').addEventListener('click', toggleRulers);
            document.getElementById('btn-snap-guides').addEventListener('click', toggleSnapToGuides);
            document.getElementById('btn-bring-front').addEventListener('click', bringToFront);
            document.getElementById('btn-send-back').addEventListener('click', sendToBack);
            document.getElementById('btn-duplicate').addEventListener('click', duplicateSelected);
            document.getElementById('btn-copy-format').addEventListener('click', copyFormat);
            document.getElementById('btn-paste-format').addEventListener('click', pasteFormat);
            document.getElementById('btn-delete').addEventListener('click', deleteSelected);
        document.getElementById('btn-group').addEventListener('click', groupElements);
        document.getElementById('btn-ungroup').addEventListener('click', ungroupElements);

            // Alignment buttons - Canvas
            document.getElementById('align-canvas-left').addEventListener('click', alignCanvasLeft);
            document.getElementById('align-canvas-center-h').addEventListener('click', alignCanvasCenterH);
            document.getElementById('align-canvas-right').addEventListener('click', alignCanvasRight);
            document.getElementById('align-canvas-top').addEventListener('click', alignCanvasTop);
            document.getElementById('align-canvas-center-v').addEventListener('click', alignCanvasCenterV);
            document.getElementById('align-canvas-bottom').addEventListener('click', alignCanvasBottom);

            // Alignment buttons - Elements
            document.getElementById('align-elem-left').addEventListener('click', alignElementsLeft);
            document.getElementById('align-elem-center-h').addEventListener('click', alignElementsCenterH);
            document.getElementById('align-elem-right').addEventListener('click', alignElementsRight);
            document.getElementById('align-elem-top').addEventListener('click', alignElementsTop);
            document.getElementById('align-elem-center-v').addEventListener('click', alignElementsCenterV);
            document.getElementById('align-elem-bottom').addEventListener('click', alignElementsBottom);

            // Distribution buttons
            document.getElementById('distribute-h').addEventListener('click', distributeHorizontally);
            document.getElementById('distribute-v').addEventListener('click', distributeVertically);

            // Rulers and guides
            rulerHorizontal.addEventListener('mousedown', (e) => startGuideFromRuler(e, 'horizontal'));
            rulerVertical.addEventListener('mousedown', (e) => startGuideFromRuler(e, 'vertical'));
            rulerCorner.addEventListener('click', clearAllGuides);

            // Zoom and pan
            canvasContainer.addEventListener('wheel', handleZoom, { passive: false });
            canvasContainer.addEventListener('mousedown', handlePanStart);
            document.getElementById('zoom-in').addEventListener('click', () => zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => zoomOut());
            document.getElementById('zoom-reset').addEventListener('click', () => zoomReset());
            document.getElementById('zoom-fit').addEventListener('click', () => zoomFit());

            // Header buttons
            document.getElementById('btn-new').addEventListener('click', () => openModal('modal-new'));
            document.getElementById('btn-clear-storage').addEventListener('click', clearLocalStorage);
            document.getElementById('btn-load').addEventListener('click', () => document.getElementById('file-load').click());
            document.getElementById('btn-save').addEventListener('click', saveProject);
            document.getElementById('btn-export').addEventListener('click', exportJSON);
            document.getElementById('btn-load-bg').addEventListener('click', () => document.getElementById('file-bg').click());
            document.getElementById('btn-shortcuts').addEventListener('click', toggleShortcuts);

            // File inputs
            document.getElementById('file-bg').addEventListener('change', handleBackgroundUpload);
            document.getElementById('file-load').addEventListener('change', handleLoadProject);

            // Preview mode
            document.getElementById('btn-preview-mode').addEventListener('click', () => {
                openModal('modal-preview');
                loadSavedProfiles();
            });
            document.getElementById('file-logo1').addEventListener('change', (e) => handlePreviewImageUpload(e, 'logo_1'));
            document.getElementById('file-logo2').addEventListener('change', (e) => handlePreviewImageUpload(e, 'logo_2'));
            document.getElementById('file-logo-verumax').addEventListener('change', (e) => handlePreviewImageUpload(e, 'logo_verumax'));
            document.getElementById('file-firma1').addEventListener('change', (e) => handlePreviewImageUpload(e, 'firma_1'));
            document.getElementById('file-firma2').addEventListener('change', (e) => handlePreviewImageUpload(e, 'firma_2'));
            document.getElementById('file-client-profile').addEventListener('change', handleLoadClientProfile);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyDown);
        }

        // ==========================================
        // ELEMENT CREATION
        // ==========================================
        function handlePaletteDragStart(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: e.target.dataset.type,
                variable: e.target.dataset.variable || '',
                text: e.target.dataset.text || e.target.dataset.variable || 'Texto',
                label: e.target.dataset.label,
                orientation: e.target.dataset.orientation || 'horizontal'
            }));
        }

        function handleCanvasDrop(e) {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            createElement(data, x, y);
        }

        function createElement(data, x, y) {
            const id = state.nextId++;

            // Determine dimensions based on type
            let width, height;
            if (data.type === 'image' || data.type === 'qr') {
                width = 80; height = 80;
            } else if (data.type === 'paragraph') {
                width = 400; height = 80;
            } else if (data.type === 'line') {
                if (data.orientation === 'vertical') {
                    width = 4; height = 100;
                } else {
                    width = 150; height = 4;
                }
            } else if (data.type === 'line-firma') {
                width = 180; height = 20;
            } else if (data.type === 'separator') {
                width = 250; height = 20;
            } else if (data.type === 'stamp') {
                width = 120; height = 35;
            } else {
                width = 200; height = 40;
            }

            let element = {
                id,
                type: data.type,
                label: data.label,
                x: snapToGrid(x),
                y: snapToGrid(y),
                width: width,
                height: height
            };

            if (data.type === 'text' || data.type === 'title' || data.type === 'text-custom' || data.type === 'paragraph') {
                element.text = data.text || data.variable || 'Texto';
                element.variable = data.variable || '';
                element.font = data.type === 'title' ? 'Georgia' : 'Arial';
                element.size = data.type === 'title' ? 36 : (data.type === 'paragraph' ? 14 : 16);
                element.color = '#333333';
                element.align = data.type === 'paragraph' ? 'left' : 'center';
                element.style = data.type === 'title' ? 'bold' : 'normal';
                element.lineHeight = data.type === 'paragraph' ? 1.5 : 1.2;
            } else if (data.type === 'image' || data.type === 'qr') {
                element.variable = data.variable;
            } else if (data.type === 'image-custom') {
                element.src = '';  // Ruta a la imagen personalizada
                element.variable = '';
                element.rotation = 0;
                element.opacity = 1;
            } else if (data.type === 'line') {
                element.orientation = data.orientation || 'horizontal';
                element.color = '#333333';
                element.thickness = 2;
                element.lineStyle = 'solid'; // solid, dashed, dotted
            } else if (data.type === 'line-firma') {
                element.color = '#333333';
                element.thickness = 1;
                element.lineStyle = 'solid';
            } else if (data.type === 'separator') {
                element.color = '#666666';
                element.thickness = 1;
                element.separatorStyle = 'dot'; // dot, diamond, double
            } else if (data.type === 'stamp') {
                element.text = data.text || '{{fecha_sello}}';
                element.color = '#1e40af';  // Azul oscuro tipo sello
                element.size = 12;
                element.rotation = -3;  // Ligera rotación para parecer sello real
                element.opacity = 0.85;
                element.borderWidth = 2;
            }

            state.elements.push(element);
            saveState();
            renderElements();
            selectElement(id);
        }

        // ==========================================
        // ELEMENT RENDERING
        // ==========================================
        function renderElements() {
            // Clear existing elements
            canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());

            // Render each element with proper z-index
            state.elements.forEach((el, index) => {
                const div = document.createElement('div');
                div.className = 'canvas-element';
                const elId = Number(el.id);
                div.dataset.id = elId;
                div.style.left = el.x + 'px';
                div.style.top = el.y + 'px';
                div.style.width = el.width + 'px';
                div.style.height = el.height + 'px';
                // Z-index basado en orden + boost para seleccionados
                const isSelected = state.selectedIds.some(sid => Number(sid) === elId);
                div.style.zIndex = index + 1 + (isSelected ? 500 : 0);

                if (el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph') {
                    div.classList.add(el.type === 'paragraph' ? 'element-paragraph' : 'element-text');
                    let displayText = replaceVariables(el.text);
                    // Aplicar formato incluso fuera de preview
                    if (!state.previewMode) {
                        displayText = applyTextFormatting(el.text);
                    }
                    div.innerHTML = `<span style="
                        font-family: '${el.font}', sans-serif;
                        font-size: ${el.size}px;
                        color: ${el.color};
                        text-align: ${el.align};
                        font-weight: ${el.style.includes('bold') ? 'bold' : 'normal'};
                        font-style: ${el.style.includes('italic') ? 'italic' : 'normal'};
                        display: block;
                        width: 100%;
                        line-height: ${el.lineHeight || 1.2};
                        white-space: ${el.type === 'paragraph' ? 'normal' : 'nowrap'};
                        overflow: hidden;
                    ">${displayText}</span>`;
                } else if (el.type === 'image' || el.type === 'qr') {
                    const previewImg = getPreviewImage(el.variable);
                    if (previewImg) {
                        div.classList.add('element-image');
                        div.style.background = 'transparent';
                        div.style.border = 'none';
                        div.innerHTML = `<img src="${previewImg}" style="width:100%; height:100%; object-fit:contain;">`;
                    } else {
                        div.classList.add('element-image');
                        div.innerHTML = `<span>${el.label || el.variable}</span>`;
                    }
                } else if (el.type === 'image-custom') {
                    div.classList.add('element-image');
                    const rotation = el.rotation || 0;
                    const opacity = el.opacity || 1;
                    div.style.transform = `rotate(${rotation}deg)`;
                    div.style.opacity = opacity;
                    if (el.src) {
                        // Mostrar la imagen desde la ruta
                        const imgPath = '../../' + el.src;  // Ruta relativa desde tools/template-editor/
                        div.style.background = 'transparent';
                        div.innerHTML = `<img src="${imgPath}" style="width:100%; height:100%; object-fit:contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'color:#999;font-size:11px;\\'>📷 ${el.src || 'Sin imagen'}</span>';">`;
                    } else {
                        div.innerHTML = `<span style="color:#999;font-size:11px;">📷 Imagen Personalizada<br><small>Editar ruta en propiedades</small></span>`;
                    }
                } else if (el.type === 'line') {
                    div.classList.add('element-line', el.orientation || 'horizontal');
                    div.style.color = el.color || '#333333';
                    const borderStyle = el.lineStyle || 'solid';
                    const thickness = el.thickness || 2;
                    if (el.orientation === 'vertical') {
                        div.innerHTML = `<div class="line-inner" style="
                            width: ${thickness}px;
                            height: 100%;
                            background: ${el.color};
                            ${borderStyle === 'dashed' ? 'background: repeating-linear-gradient(to bottom, ' + el.color + ' 0, ' + el.color + ' 5px, transparent 5px, transparent 10px);' : ''}
                            ${borderStyle === 'dotted' ? 'background: repeating-linear-gradient(to bottom, ' + el.color + ' 0, ' + el.color + ' 2px, transparent 2px, transparent 6px);' : ''}
                        "></div>`;
                    } else {
                        div.innerHTML = `<div class="line-inner" style="
                            width: 100%;
                            height: ${thickness}px;
                            background: ${el.color};
                            ${borderStyle === 'dashed' ? 'background: repeating-linear-gradient(to right, ' + el.color + ' 0, ' + el.color + ' 10px, transparent 10px, transparent 20px);' : ''}
                            ${borderStyle === 'dotted' ? 'background: repeating-linear-gradient(to right, ' + el.color + ' 0, ' + el.color + ' 3px, transparent 3px, transparent 8px);' : ''}
                        "></div>`;
                    }
                } else if (el.type === 'line-firma') {
                    div.classList.add('element-line-firma');
                    div.style.color = el.color || '#333333';
                    const thickness = el.thickness || 1;
                    div.innerHTML = `<div class="firma-line" style="height: ${thickness}px; background: ${el.color};"></div>`;
                } else if (el.type === 'separator') {
                    div.classList.add('element-separator');
                    div.style.color = el.color || '#666666';
                    const sepStyle = el.separatorStyle || 'dot';
                    let centerElement = '';
                    if (sepStyle === 'dot') {
                        centerElement = `<div class="sep-dot"></div>`;
                    } else if (sepStyle === 'diamond') {
                        centerElement = `<div class="sep-dot" style="transform: rotate(45deg); border-radius: 0;"></div>`;
                    } else if (sepStyle === 'double') {
                        centerElement = `<div class="sep-dot"></div><div class="sep-dot"></div>`;
                    }
                    div.innerHTML = `<div class="sep-inner">
                        <div class="sep-line"></div>
                        ${centerElement}
                        <div class="sep-line"></div>
                    </div>`;
                } else if (el.type === 'stamp') {
                    div.classList.add('element-stamp');
                    const rotation = el.rotation || 0;
                    const opacity = el.opacity || 0.85;
                    const borderWidth = el.borderWidth !== undefined ? el.borderWidth : 2;
                    const fontSize = el.size || 12;
                    const color = el.color || '#1e40af';
                    let displayText = replaceVariables(el.text || '{{fecha_sello}}');
                    div.style.color = color;
                    if (borderWidth > 0) {
                        div.style.borderColor = color;
                        div.style.borderWidth = borderWidth + 'px';
                    } else {
                        div.style.border = 'none';
                    }
                    div.style.transform = `rotate(${rotation}deg)`;
                    div.style.opacity = opacity;
                    div.style.fontSize = fontSize + 'px';
                    div.innerHTML = `<span class="stamp-text">${displayText}</span>`;
                }

                // Resize handles
                div.innerHTML += `
                    <div class="resize-handle nw" data-handle="nw"></div>
                    <div class="resize-handle ne" data-handle="ne"></div>
                    <div class="resize-handle sw" data-handle="sw"></div>
                    <div class="resize-handle se" data-handle="se"></div>
                `;

                if (elId === Number(state.selectedId)) {
                    div.classList.add('selected');
                }

                // Add grouped class and indicator
                if (el.groupId) {
                    div.classList.add('grouped');
                    const groupIndicator = document.createElement('div');
                    groupIndicator.className = 'group-indicator';
                    groupIndicator.textContent = 'Grupo ' + el.groupId;
                    div.appendChild(groupIndicator);
                }

                // Event listeners - usar elId (número) para consistencia
                div.addEventListener('mousedown', e => handleElementMouseDown(e, elId));
                div.querySelectorAll('.resize-handle').forEach(handle => {
                    handle.addEventListener('mousedown', e => handleResizeStart(e, elId, handle.dataset.handle));
                });

                canvas.appendChild(div);
            });

            updateLayersList();
        }

        // ==========================================
        // ELEMENT INTERACTION
        // ==========================================
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeHandle = null;
        let resizeStart = {};

        // Ciclar entre elementos superpuestos (Alt+Click)
        function cycleOverlappingElements(clientX, clientY) {
            const canvasRect = canvas.getBoundingClientRect();
            const x = clientX - canvasRect.left;
            const y = clientY - canvasRect.top;

            // Encontrar todos los elementos que contienen este punto
            const overlapping = state.elements.filter(el => {
                return x >= el.x && x <= el.x + el.width &&
                       y >= el.y && y <= el.y + el.height;
            });

            if (overlapping.length === 0) return;

            if (overlapping.length === 1) {
                selectElement(overlapping[0].id);
                showToast('Solo hay un elemento en esta posición');
                return;
            }

            // Encontrar el índice del elemento actualmente seleccionado
            const numericSelectedId = Number(state.selectedId);
            const currentIdx = overlapping.findIndex(el => Number(el.id) === numericSelectedId);
            // Ir al siguiente (o al primero si es el último o no hay seleccionado)
            const nextIdx = (currentIdx + 1) % overlapping.length;
            selectElement(overlapping[nextIdx].id);
            showToast(`Elemento ${nextIdx + 1} de ${overlapping.length} superpuestos`);
        }

        // Safety reset para flags atascados
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                canvas.querySelectorAll('.canvas-element.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });
            }
            if (isResizing) {
                isResizing = false;
            }
        });

        // Reset cuando se pierde el foco de la ventana
        window.addEventListener('blur', () => {
            isDragging = false;
            isResizing = false;
            canvas.querySelectorAll('.canvas-element.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
        });

        function handleElementMouseDown(e, id) {
            if (e.target.classList.contains('resize-handle')) return;

            e.stopPropagation();

            const numericId = Number(id);
            console.log('handleElementMouseDown - ID:', numericId);

            // Alt+Click para ciclar entre elementos superpuestos
            if (e.altKey) {
                cycleOverlappingElements(e.clientX, e.clientY);
                return;
            }

            // Ctrl o Shift para selección múltiple
            const addToSelection = e.ctrlKey || e.shiftKey;
            selectElement(numericId, addToSelection);

            const el = state.elements.find(elem => Number(elem.id) === numericId);
            if (!el) {
                console.error('Elemento no encontrado en state.elements para ID:', numericId);
                return;
            }

            // Solo arrastrar si no estamos agregando a la selección
            if (addToSelection && state.selectedIds.length > 1) {
                return; // No iniciar drag al agregar elementos
            }

            isDragging = true;
            dragOffset = {
                x: e.clientX - el.x,
                y: e.clientY - el.y
            };

            // Calculate delta for group movement
            const startX = el.x;
            const startY = el.y;

            // Get all elements to move (group or just this element)
            const elementsToMove = el.groupId
                ? state.elements.filter(e => e.groupId === el.groupId)
                : [el];

            // Store initial positions of all elements
            const initialPositions = elementsToMove.map(e => ({ id: e.id, x: e.x, y: e.y }));

            const moveHandler = (e) => {
                if (!isDragging) return;

                let newX = e.clientX - dragOffset.x;
                let newY = e.clientY - dragOffset.y;

                // Constrain to canvas
                const canvasRect = canvas.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, canvasRect.width - el.width));
                newY = Math.max(0, Math.min(newY, canvasRect.height - el.height));

                // Snap to grid
                newX = snapToGrid(newX);
                newY = snapToGrid(newY);

                // Snap to guides
                const snapped = applySnapping(newX, newY, el.width, el.height);
                newX = snapped.x;
                newY = snapped.y;

                // Calculate delta from initial position
                const deltaX = newX - startX;
                const deltaY = newY - startY;

                // Move all elements in group (or just the single element)
                elementsToMove.forEach((moveEl, idx) => {
                    const initial = initialPositions[idx];
                    let newElX = initial.x + deltaX;
                    let newElY = initial.y + deltaY;

                    // Aplicar clamp para mantener elemento dentro del canvas
                    const clamped = clampToCanvas(newElX, newElY, moveEl.width, moveEl.height);
                    moveEl.x = clamped.x;
                    moveEl.y = clamped.y;

                    const domEl = canvas.querySelector(`[data-id="${moveEl.id}"]`);
                    if (domEl) {
                        domEl.style.left = moveEl.x + 'px';
                        domEl.style.top = moveEl.y + 'px';
                        if (moveEl.id === el.id) {
                            domEl.classList.add('dragging');
                        }
                    }
                });

                updatePropertiesPanel();
            };

            const upHandler = () => {
                if (isDragging) {
                    isDragging = false;
                    const domEl = canvas.querySelector(`[data-id="${id}"]`);
                    if (domEl) domEl.classList.remove('dragging');
                    saveState();
                }
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            };

            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }

        function handleResizeStart(e, id, handle) {
            e.stopPropagation();

            const numericId = Number(id);
            const el = state.elements.find(elem => Number(elem.id) === numericId);
            if (!el) {
                console.error('handleResizeStart - Elemento no encontrado para ID:', numericId);
                return;
            }

            isResizing = true;
            resizeHandle = handle;
            resizeStart = {
                x: e.clientX,
                y: e.clientY,
                width: el.width,
                height: el.height,
                elX: el.x,
                elY: el.y,
                aspectRatio: el.width / el.height  // Guardar proporción original
            };

            const moveHandler = (e) => {
                if (!isResizing) return;

                const dx = e.clientX - resizeStart.x;
                const dy = e.clientY - resizeStart.y;
                const shiftKey = e.shiftKey;  // Shift para mantener proporción

                let newWidth = resizeStart.width;
                let newHeight = resizeStart.height;
                let newX = resizeStart.elX;
                let newY = resizeStart.elY;

                // Calcular nuevas dimensiones según el handle
                if (resizeHandle.includes('e')) {
                    newWidth = Math.max(20, resizeStart.width + dx);
                }
                if (resizeHandle.includes('w')) {
                    newWidth = Math.max(20, resizeStart.width - dx);
                    newX = resizeStart.elX + resizeStart.width - newWidth;
                }
                if (resizeHandle.includes('s')) {
                    newHeight = Math.max(20, resizeStart.height + dy);
                }
                if (resizeHandle.includes('n')) {
                    newHeight = Math.max(20, resizeStart.height - dy);
                    newY = resizeStart.elY + resizeStart.height - newHeight;
                }

                // Si Shift está presionado, mantener proporción
                if (shiftKey) {
                    const aspectRatio = resizeStart.aspectRatio;

                    // Determinar qué dimensión usar como base según el handle
                    if (resizeHandle === 'se' || resizeHandle === 'ne' || resizeHandle === 'sw' || resizeHandle === 'nw') {
                        // Esquinas: usar el cambio más grande como referencia
                        const widthChange = Math.abs(newWidth - resizeStart.width);
                        const heightChange = Math.abs(newHeight - resizeStart.height);

                        if (widthChange > heightChange) {
                            // Ancho cambió más, ajustar alto
                            newHeight = newWidth / aspectRatio;
                        } else {
                            // Alto cambió más, ajustar ancho
                            newWidth = newHeight * aspectRatio;
                        }

                        // Ajustar posición para handles que mueven origen
                        if (resizeHandle.includes('w')) {
                            newX = resizeStart.elX + resizeStart.width - newWidth;
                        }
                        if (resizeHandle.includes('n')) {
                            newY = resizeStart.elY + resizeStart.height - newHeight;
                        }
                    } else if (resizeHandle === 'e' || resizeHandle === 'w') {
                        // Solo horizontal: ajustar alto según ancho
                        newHeight = newWidth / aspectRatio;
                    } else if (resizeHandle === 'n' || resizeHandle === 's') {
                        // Solo vertical: ajustar ancho según alto
                        newWidth = newHeight * aspectRatio;
                    }

                    // Asegurar mínimos
                    newWidth = Math.max(20, newWidth);
                    newHeight = Math.max(20, newHeight);
                }

                el.width = snapToGrid(newWidth);
                el.height = snapToGrid(newHeight);

                // Aplicar clamp para mantener elemento dentro del canvas
                const clamped = clampToCanvas(snapToGrid(newX), snapToGrid(newY), el.width, el.height);
                el.x = clamped.x;
                el.y = clamped.y;

                const domEl = canvas.querySelector(`[data-id="${id}"]`);
                if (domEl) {
                    domEl.style.width = el.width + 'px';
                    domEl.style.height = el.height + 'px';
                    domEl.style.left = el.x + 'px';
                    domEl.style.top = el.y + 'px';
                }

                updatePropertiesPanel();
            };

            const upHandler = () => {
                isResizing = false;
                resizeHandle = null;
                saveState();
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            };

            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }

        // ==========================================
        // SELECTION
        // ==========================================
        function selectElement(id, addToSelection = false, skipGroupSelection = false) {
            // Normalizar ID a número (o null)
            const numericId = id === null ? null : Number(id);
            console.log('selectElement llamado con ID:', numericId, 'addToSelection:', addToSelection);

            if (numericId === null) {
                // Deseleccionar todo
                state.selectedId = null;
                state.selectedIds = [];
                console.log('Deseleccionado todo');
            } else if (addToSelection) {
                // Agregar/quitar de selección múltiple (Ctrl+click o Shift+click)
                const idx = state.selectedIds.findIndex(sid => Number(sid) === numericId);
                if (idx > -1) {
                    // Ya está seleccionado, quitarlo
                    state.selectedIds.splice(idx, 1);
                    if (Number(state.selectedId) === numericId) {
                        state.selectedId = state.selectedIds.length > 0 ? state.selectedIds[state.selectedIds.length - 1] : null;
                    }
                } else {
                    // Agregarlo a la selección
                    state.selectedIds.push(numericId);
                    state.selectedId = numericId;
                }
            } else {
                // Selección simple
                state.selectedId = numericId;
                state.selectedIds = [numericId];
                console.log('Selección simple - selectedId:', state.selectedId, 'selectedIds:', state.selectedIds);
            }

            // Verificar que el elemento exista en state.elements
            const elementExists = state.elements.some(e => Number(e.id) === numericId);
            if (numericId !== null && !elementExists) {
                console.error('ADVERTENCIA: ID seleccionado no existe en state.elements!', numericId);
                console.log('IDs disponibles:', state.elements.map(e => e.id));
            }

            // Actualizar clases visuales en ambos canvas
            const allCanvasElements = [
                ...document.getElementById('canvas-no-rulers').querySelectorAll('.canvas-element'),
                ...document.getElementById('canvas').querySelectorAll('.canvas-element')
            ];
            allCanvasElements.forEach(el => {
                const elId = Number(el.dataset.id);
                const isSelected = state.selectedIds.some(sid => Number(sid) === elId);
                el.classList.toggle('selected', isSelected);
            });

            updatePropertiesPanel();
            updateLayersList();
            updateAlignButtons();
            updateGroupButtons();
        }

        function updateAlignButtons() {
            // Habilitar/deshabilitar botones de alineación según selección
            const hasSelection = state.selectedIds.length > 0;
            const hasMultiple = state.selectedIds.length > 1;

            // Alineación al canvas - requiere al menos 1 elemento
            document.querySelectorAll('.align-canvas-btn').forEach(btn => {
                btn.disabled = !hasSelection;
            });

            // Alineación entre elementos - requiere 2+ elementos
            document.querySelectorAll('.align-elements-btn').forEach(btn => {
                btn.disabled = !hasMultiple;
            });

            // Distribución - requiere 3+ elementos
            document.querySelectorAll('.distribute-btn').forEach(btn => {
                btn.disabled = state.selectedIds.length < 3;
            });
        }

        function updatePropertiesPanel() {
            console.log('updatePropertiesPanel - state.selectedId:', state.selectedId);
            const numericSelectedId = Number(state.selectedId);
            const el = state.elements.find(e => Number(e.id) === numericSelectedId);
            const lineProperties = document.getElementById('line-properties');
            const separatorProperties = document.getElementById('separator-properties');
            const stampProperties = document.getElementById('stamp-properties');

            if (!el) {
                console.log('updatePropertiesPanel - No se encontró elemento. selectedId:', state.selectedId, 'numericSelectedId:', numericSelectedId);
                if (state.selectedId !== null) {
                    console.log('IDs en state.elements:', state.elements.map(e => ({ id: e.id, tipo: typeof e.id })));
                }
                noSelection.style.display = 'block';
                elementProperties.style.display = 'none';
                return;
            }
            console.log('updatePropertiesPanel - Elemento encontrado:', el.type, el.label || el.text?.substring(0, 20));

            noSelection.style.display = 'none';
            elementProperties.style.display = 'block';

            // Position
            document.getElementById('prop-x').value = Math.round(el.x);
            document.getElementById('prop-y').value = Math.round(el.y);
            document.getElementById('prop-width').value = Math.round(el.width);
            document.getElementById('prop-height').value = Math.round(el.height);

            // Hide all type-specific panels first
            textProperties.style.display = 'none';
            imageProperties.style.display = 'none';
            lineProperties.style.display = 'none';
            separatorProperties.style.display = 'none';
            stampProperties.style.display = 'none';

            // Show/hide type-specific properties
            if (el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph') {
                textProperties.style.display = 'block';

                // Obtener contenedores de texto
                const simpleTextContainer = document.getElementById('simple-text-container');
                const paragraphTextContainer = document.getElementById('paragraph-text-container');

                if (el.type === 'paragraph' || el.type === 'text-custom') {
                    // Mostrar tabs estudiante/docente para párrafos y text-custom
                    simpleTextContainer.style.display = 'none';
                    paragraphTextContainer.style.display = 'block';

                    // Cargar textos de aprobacion, finalizacion y docente
                    document.getElementById('prop-text-aprobacion').value = el.text || '';
                    document.getElementById('prop-text-finalizacion').value = el.text_finalizacion || '';
                    document.getElementById('prop-text-docente').value = el.text_docente || '';
                    // Cargar text_key de variantes
                    document.getElementById('prop-text-key-aprobacion').value = el.text_key || '';
                    document.getElementById('prop-text-key-finalizacion').value = el.text_key_finalizacion || '';
                    document.getElementById('prop-text-key-docente').value = el.text_key_docente || '';

                    // Resetear tabs al de aprobacion
                    switchParagraphTab('aprobacion');
                } else {
                    // Mostrar campo de texto simple para otros tipos (text, title)
                    simpleTextContainer.style.display = 'block';
                    paragraphTextContainer.style.display = 'none';

                    document.getElementById('prop-text').value = el.text;
                    document.getElementById('prop-text-key').value = el.text_key || '';
                }

                document.getElementById('prop-font').value = el.font;
                document.getElementById('prop-size').value = el.size;
                document.getElementById('prop-color').value = el.color;
                document.getElementById('prop-color-text').value = el.color;
                document.getElementById('prop-align').value = el.align;
                document.getElementById('prop-style').value = el.style;
            } else if (el.type === 'line' || el.type === 'line-firma') {
                lineProperties.style.display = 'block';

                document.getElementById('prop-line-color').value = el.color || '#333333';
                document.getElementById('prop-line-color-text').value = el.color || '#333333';
                document.getElementById('prop-line-thickness').value = el.thickness || 2;
                document.getElementById('prop-line-style').value = el.lineStyle || 'solid';
            } else if (el.type === 'separator') {
                separatorProperties.style.display = 'block';

                document.getElementById('prop-sep-color').value = el.color || '#666666';
                document.getElementById('prop-sep-color-text').value = el.color || '#666666';
                document.getElementById('prop-sep-style').value = el.separatorStyle || 'dot';
            } else if (el.type === 'stamp') {
                stampProperties.style.display = 'block';

                document.getElementById('prop-stamp-text').value = el.text || '{{fecha_sello}}';
                document.getElementById('prop-stamp-color').value = el.color || '#1e40af';
                document.getElementById('prop-stamp-color-text').value = el.color || '#1e40af';
                document.getElementById('prop-stamp-size').value = el.size || 12;
                document.getElementById('prop-stamp-rotation').value = el.rotation || 0;
                document.getElementById('prop-stamp-opacity').value = el.opacity || 0.85;
                document.getElementById('prop-stamp-opacity-value').textContent = Math.round((el.opacity || 0.85) * 100) + '%';
                document.getElementById('prop-stamp-border').value = el.borderWidth !== undefined ? el.borderWidth : 2;
            } else if (el.type === 'image' || el.type === 'qr') {
                imageProperties.style.display = 'block';
                document.getElementById('prop-variable-row').style.display = 'flex';
                document.getElementById('prop-src-row').style.display = 'none';
                document.getElementById('prop-src-help').style.display = 'none';
                document.getElementById('prop-img-rotation-row').style.display = 'none';
                document.getElementById('prop-img-opacity-row').style.display = 'none';
                document.getElementById('prop-variable').value = el.variable;
            } else if (el.type === 'image-custom') {
                imageProperties.style.display = 'block';
                document.getElementById('prop-variable-row').style.display = 'none';
                document.getElementById('prop-src-row').style.display = 'flex';
                document.getElementById('prop-src-help').style.display = 'block';
                document.getElementById('prop-img-rotation-row').style.display = 'flex';
                document.getElementById('prop-img-opacity-row').style.display = 'flex';
                document.getElementById('prop-src').value = el.src || '';
                document.getElementById('prop-img-rotation').value = el.rotation || 0;
                document.getElementById('prop-img-opacity').value = el.opacity || 1;
                document.getElementById('prop-img-opacity-value').textContent = Math.round((el.opacity || 1) * 100) + '%';
            }
        }

        function updateElementFromProps() {
            const numericSelectedId = Number(state.selectedId);
            const el = state.elements.find(e => Number(e.id) === numericSelectedId);
            if (!el) return;

            el.x = parseInt(document.getElementById('prop-x').value) || 0;
            el.y = parseInt(document.getElementById('prop-y').value) || 0;
            el.width = parseInt(document.getElementById('prop-width').value) || 50;
            el.height = parseInt(document.getElementById('prop-height').value) || 20;

            if (el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph') {
                if (el.type === 'paragraph' || el.type === 'text-custom') {
                    // Para párrafos y text-custom, guardar texto de aprobacion, finalizacion y docente
                    el.text = document.getElementById('prop-text-aprobacion').value;
                    el.text_finalizacion = document.getElementById('prop-text-finalizacion').value;
                    el.text_docente = document.getElementById('prop-text-docente').value;
                    // Guardar text_key de variantes
                    const textKeyAprobacion = document.getElementById('prop-text-key-aprobacion').value;
                    const textKeyFinalizacion = document.getElementById('prop-text-key-finalizacion').value;
                    const textKeyDocente = document.getElementById('prop-text-key-docente').value;
                    el.text_key = textKeyAprobacion || null;
                    el.text_key_finalizacion = textKeyFinalizacion || null;
                    el.text_key_docente = textKeyDocente || null;
                } else {
                    el.text = document.getElementById('prop-text').value;
                    // Guardar text_key para internacionalización (solo para text/title simples)
                    const textKeyValue = document.getElementById('prop-text-key').value;
                    el.text_key = textKeyValue || null;
                }
                el.font = document.getElementById('prop-font').value;
                el.size = parseInt(document.getElementById('prop-size').value) || 16;
                el.align = document.getElementById('prop-align').value;
                el.style = document.getElementById('prop-style').value;
            } else if (el.type === 'line' || el.type === 'line-firma') {
                el.thickness = parseInt(document.getElementById('prop-line-thickness').value) || 2;
                el.lineStyle = document.getElementById('prop-line-style').value;
            } else if (el.type === 'separator') {
                el.separatorStyle = document.getElementById('prop-sep-style').value;
            } else if (el.type === 'image-custom') {
                el.src = document.getElementById('prop-src').value;
            }

            renderElements();
        }

        // Helper para encontrar elemento seleccionado con comparación numérica
        function getSelectedElement() {
            const numericSelectedId = Number(state.selectedId);
            return state.elements.find(e => Number(e.id) === numericSelectedId);
        }

        function handleColorChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            el.color = e.target.value;
            document.getElementById('prop-color-text').value = e.target.value;
            renderElements();
        }

        function handleColorTextChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            const color = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                el.color = color;
                document.getElementById('prop-color').value = color;
                renderElements();
            }
        }

        function handleLineColorChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            el.color = e.target.value;
            document.getElementById('prop-line-color-text').value = e.target.value;
            renderElements();
        }

        function handleLineColorTextChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            const color = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                el.color = color;
                document.getElementById('prop-line-color').value = color;
                renderElements();
            }
        }

        function handleSepColorChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            el.color = e.target.value;
            document.getElementById('prop-sep-color-text').value = e.target.value;
            renderElements();
        }

        function handleSepColorTextChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            const color = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                el.color = color;
                document.getElementById('prop-sep-color').value = color;
                renderElements();
            }
        }

        // Stamp handlers
        function updateStampFromProps() {
            const el = getSelectedElement();
            if (!el || el.type !== 'stamp') return;

            el.text = document.getElementById('prop-stamp-text').value;
            el.size = parseInt(document.getElementById('prop-stamp-size').value) || 12;
            el.rotation = parseInt(document.getElementById('prop-stamp-rotation').value) || 0;
            el.opacity = parseFloat(document.getElementById('prop-stamp-opacity').value) || 0.85;
            const borderVal = parseInt(document.getElementById('prop-stamp-border').value);
            el.borderWidth = isNaN(borderVal) ? 2 : borderVal;
            renderElements();
        }

        function handleStampColorChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            el.color = e.target.value;
            document.getElementById('prop-stamp-color-text').value = e.target.value;
            renderElements();
        }

        function handleStampColorTextChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            const color = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                el.color = color;
                document.getElementById('prop-stamp-color').value = color;
                renderElements();
            }
        }

        function handleStampOpacityChange(e) {
            const el = getSelectedElement();
            if (!el) return;

            el.opacity = parseFloat(e.target.value);
            document.getElementById('prop-stamp-opacity-value').textContent = Math.round(el.opacity * 100) + '%';
            renderElements();
        }

        // Image custom handlers
        function updateImageCustomFromProps() {
            const el = getSelectedElement();
            if (!el || el.type !== 'image-custom') return;

            el.rotation = parseInt(document.getElementById('prop-img-rotation').value) || 0;
            renderElements();
        }

        function handleImageOpacityChange(e) {
            const el = getSelectedElement();
            if (!el || el.type !== 'image-custom') return;

            el.opacity = parseFloat(e.target.value);
            document.getElementById('prop-img-opacity-value').textContent = Math.round(el.opacity * 100) + '%';
            renderElements();
        }

        // ==========================================
        // LAYERS
        // ==========================================
        function updateLayersList() {
            layersList.innerHTML = '';

            [...state.elements].reverse().forEach(el => {
                const item = document.createElement('div');
                const isSelected = Number(el.id) === Number(state.selectedId);
                item.className = 'layer-item' + (isSelected ? ' selected' : '');
                const elId = Number(el.id); // Asegurar que es número
                const groupBadge = el.groupId ? '<span class="group-badge">G' + el.groupId + '</span>' : '';
                if (el.groupId) {
                    item.classList.add('is-group');
                }
                item.innerHTML = `
                    <span>${el.label || el.text?.substring(0, 20) || 'Elemento'}${groupBadge}</span>
                    <div class="layer-actions">
                        <button class="layer-btn" title="Subir" onclick="moveLayerUp(${elId})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
                        </button>
                        <button class="layer-btn" title="Bajar" onclick="moveLayerDown(${elId})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        </button>
                        <button class="layer-btn layer-btn-delete" title="Eliminar" onclick="deleteElementById(${elId})" style="color: #dc2626;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.layer-btn')) {
                        selectElement(elId);
                    }
                });
                layersList.appendChild(item);
            });
        }

        function deleteElementById(id) {
            // Normalizar ID a número
            const numericId = Number(id);
            console.log('deleteElementById llamado con:', id, 'tipo:', typeof id, 'numericId:', numericId);
            console.log('Elementos actuales:', state.elements.map(e => ({ id: e.id, tipo: typeof e.id, label: e.label })));

            const beforeCount = state.elements.length;

            // Filtrar usando comparación numérica
            state.elements = state.elements.filter(e => {
                const elemId = Number(e.id);
                const shouldKeep = elemId !== numericId;
                if (!shouldKeep) {
                    console.log('Eliminando elemento:', e.id, e.label);
                }
                return shouldKeep;
            });

            const afterCount = state.elements.length;

            if (beforeCount === afterCount) {
                console.error('No se pudo eliminar elemento. ID buscado:', numericId, 'IDs disponibles:', state.elements.map(e => e.id));
                showToast('Error al eliminar - ver consola');
                return;
            }

            // Limpiar selección si era el elemento eliminado
            if (Number(state.selectedId) === numericId) {
                state.selectedId = null;
                state.selectedIds = [];
            }
            // También limpiar de selectedIds si estaba allí
            state.selectedIds = state.selectedIds.filter(sid => Number(sid) !== numericId);

            saveState();
            renderElements();
            updatePropertiesPanel();
            showToast('Elemento eliminado');
            console.log('Eliminación exitosa. Elementos restantes:', state.elements.length);
        }

        function moveLayerUp(id) {
            const numericId = Number(id);
            const idx = state.elements.findIndex(e => Number(e.id) === numericId);
            if (idx >= 0 && idx < state.elements.length - 1) {
                [state.elements[idx], state.elements[idx + 1]] = [state.elements[idx + 1], state.elements[idx]];
                saveState();
                renderElements();
            }
        }

        function moveLayerDown(id) {
            const numericId = Number(id);
            const idx = state.elements.findIndex(e => Number(e.id) === numericId);
            if (idx > 0) {
                [state.elements[idx], state.elements[idx - 1]] = [state.elements[idx - 1], state.elements[idx]];
                saveState();
                renderElements();
            }
        }

        function bringToFront() {
            if (!state.selectedId) return;
            const numericId = Number(state.selectedId);
            const idx = state.elements.findIndex(e => Number(e.id) === numericId);
            if (idx >= 0) {
                const [el] = state.elements.splice(idx, 1);
                state.elements.push(el);
                saveState();
                renderElements();
            }
        }

        function sendToBack() {
            if (!state.selectedId) return;
            const numericId = Number(state.selectedId);
            const idx = state.elements.findIndex(e => Number(e.id) === numericId);
            if (idx >= 0) {
                const [el] = state.elements.splice(idx, 1);
                state.elements.unshift(el);
                saveState();
                renderElements();
            }
        }

        // ==========================================
        // HISTORY (Undo/Redo)
        // ==========================================
        function saveState() {
            // Remove future states if we're not at the end
            state.history = state.history.slice(0, state.historyIndex + 1);

            // Save current state
            state.history.push(JSON.stringify({
                elements: state.elements,
                nextId: state.nextId
            }));
            state.historyIndex = state.history.length - 1;

            // Limit history
            if (state.history.length > 50) {
                state.history.shift();
                state.historyIndex--;
            }

            updateUndoRedoButtons();
            saveToLocalStorage();
        }

        function undo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                restoreState();
            }
        }

        function redo() {
            if (state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                restoreState();
            }
        }

        function restoreState() {
            const saved = JSON.parse(state.history[state.historyIndex]);
            state.elements = saved.elements;
            state.nextId = saved.nextId;
            state.selectedId = null;
            renderElements();
            updatePropertiesPanel();
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            document.getElementById('btn-undo').disabled = state.historyIndex <= 0;
            document.getElementById('btn-redo').disabled = state.historyIndex >= state.history.length - 1;
        }

        // ==========================================
        // GRID & SNAP
        // ==========================================
        function toggleGrid() {
            state.gridVisible = !state.gridVisible;
            canvasGrid.classList.toggle('visible', state.gridVisible);
            // Also toggle the other canvas grid
            if (state.rulersVisible) {
                canvasGridWithRulers.classList.toggle('visible', state.gridVisible);
            } else {
                document.getElementById('canvas-grid-no-rulers').classList.toggle('visible', state.gridVisible);
            }
            document.getElementById('btn-grid').classList.toggle('active', state.gridVisible);
        }

        function toggleSnap() {
            state.snapEnabled = !state.snapEnabled;
            document.getElementById('btn-snap').classList.toggle('active', state.snapEnabled);
            showToast(state.snapEnabled ? 'Snap a grilla activado' : 'Snap a grilla desactivado');
        }

        function snapToGrid(value) {
            if (!state.snapEnabled) return value;
            return Math.round(value / state.snapSize) * state.snapSize;
        }

        // Función para asegurar que un elemento quede dentro del canvas
        function clampToCanvas(x, y, width, height) {
            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;

            // Asegurar que x + width no exceda el canvas
            let clampedX = Math.max(0, Math.min(x, canvasWidth - width));
            let clampedY = Math.max(0, Math.min(y, canvasHeight - height));

            // Si el elemento es más grande que el canvas, al menos que empiece en 0
            if (width > canvasWidth) clampedX = 0;
            if (height > canvasHeight) clampedY = 0;

            return { x: clampedX, y: clampedY };
        }

        // ==========================================
        // RULERS AND GUIDES
        // ==========================================
        function toggleRulers() {
            state.rulersVisible = !state.rulersVisible;
            document.getElementById('btn-rulers').classList.toggle('active', state.rulersVisible);

            if (state.rulersVisible) {
                // Show rulers, hide non-rulers canvas
                rulersContainer.style.display = 'flex';
                canvasWrapperNoRulers.style.display = 'none';

                // Switch canvas references
                canvas = canvasWithRulers;
                canvasGrid = canvasGridWithRulers;
                guidesContainer = guidesContainerWithRulers;

                // Render rulers
                renderRulers();
            } else {
                // Hide rulers, show non-rulers canvas
                rulersContainer.style.display = 'none';
                canvasWrapperNoRulers.style.display = 'block';

                // Switch canvas references
                canvas = document.getElementById('canvas-no-rulers');
                canvasGrid = document.getElementById('canvas-grid-no-rulers');
                guidesContainer = document.getElementById('guides-container-no-rulers');
            }

            // Re-render elements and guides on new canvas
            canvasGrid.classList.toggle('visible', state.gridVisible);
            renderElements();
            renderGuides();

            showToast(state.rulersVisible ? 'Reglas activadas - arrastra para crear guias' : 'Reglas desactivadas');
        }

        function toggleSnapToGuides() {
            state.snapToGuides = !state.snapToGuides;
            document.getElementById('btn-snap-guides').classList.toggle('active', state.snapToGuides);
            showToast(state.snapToGuides ? 'Snap a guias activado' : 'Snap a guias desactivado');
        }

        function renderRulers() {
            const canvasWidth = state.orientation === 'landscape' ? 842 : 595;
            const canvasHeight = state.orientation === 'landscape' ? 595 : 842;

            // Set ruler dimensions
            rulerHorizontal.style.width = canvasWidth + 'px';
            rulerVertical.style.height = canvasHeight + 'px';

            // Clear existing ticks
            rulerHorizontal.innerHTML = '';
            rulerVertical.innerHTML = '';

            // Render horizontal ruler ticks
            for (let i = 0; i <= canvasWidth; i += 10) {
                const tick = document.createElement('div');
                tick.className = 'ruler-tick ' + (i % 50 === 0 ? 'major' : 'minor');
                tick.style.left = i + 'px';
                rulerHorizontal.appendChild(tick);

                if (i % 100 === 0 && i > 0) {
                    const num = document.createElement('span');
                    num.className = 'ruler-number';
                    num.style.left = i + 'px';
                    num.textContent = i;
                    rulerHorizontal.appendChild(num);
                }
            }

            // Render vertical ruler ticks
            for (let i = 0; i <= canvasHeight; i += 10) {
                const tick = document.createElement('div');
                tick.className = 'ruler-tick ' + (i % 50 === 0 ? 'major' : 'minor');
                tick.style.top = i + 'px';
                rulerVertical.appendChild(tick);

                if (i % 100 === 0 && i > 0) {
                    const num = document.createElement('span');
                    num.className = 'ruler-number';
                    num.style.top = i + 'px';
                    num.textContent = i;
                    rulerVertical.appendChild(num);
                }
            }
        }

        function startGuideFromRuler(e, orientation) {
            e.preventDefault();

            const canvasRect = canvas.getBoundingClientRect();
            let guideId = Date.now();
            let position;

            if (orientation === 'horizontal') {
                position = e.clientY - canvasRect.top;
            } else {
                position = e.clientX - canvasRect.left;
            }

            // Create temporary guide
            const guide = {
                id: guideId,
                orientation: orientation,
                position: position
            };

            state.guides.push(guide);
            renderGuides();

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'guide-tooltip';
            tooltip.id = 'guide-tooltip-' + guideId;
            document.body.appendChild(tooltip);

            const moveGuide = (moveE) => {
                const newCanvasRect = canvas.getBoundingClientRect();
                let newPosition;

                if (orientation === 'horizontal') {
                    newPosition = moveE.clientY - newCanvasRect.top;
                    // Clamp to canvas
                    newPosition = Math.max(0, Math.min(newPosition, canvas.offsetHeight));
                } else {
                    newPosition = moveE.clientX - newCanvasRect.left;
                    // Clamp to canvas
                    newPosition = Math.max(0, Math.min(newPosition, canvas.offsetWidth));
                }

                // Update guide position
                const guideIndex = state.guides.findIndex(g => g.id === guideId);
                if (guideIndex !== -1) {
                    state.guides[guideIndex].position = newPosition;
                    renderGuides();

                    // Update tooltip
                    tooltip.textContent = Math.round(newPosition) + 'px';
                    tooltip.style.left = (moveE.clientX + 15) + 'px';
                    tooltip.style.top = (moveE.clientY + 15) + 'px';
                }
            };

            const stopGuide = (upE) => {
                document.removeEventListener('mousemove', moveGuide);
                document.removeEventListener('mouseup', stopGuide);

                // Remove tooltip
                tooltip.remove();

                // Check if guide is outside canvas (remove it)
                const finalGuide = state.guides.find(g => g.id === guideId);
                if (finalGuide) {
                    if (orientation === 'horizontal') {
                        if (finalGuide.position < 0 || finalGuide.position > canvas.offsetHeight) {
                            state.guides = state.guides.filter(g => g.id !== guideId);
                            renderGuides();
                        }
                    } else {
                        if (finalGuide.position < 0 || finalGuide.position > canvas.offsetWidth) {
                            state.guides = state.guides.filter(g => g.id !== guideId);
                            renderGuides();
                        }
                    }
                }

                updateRulerCorner();
            };

            document.addEventListener('mousemove', moveGuide);
            document.addEventListener('mouseup', stopGuide);
        }

        function renderGuides() {
            // Clear guides from both containers
            document.getElementById('guides-container').innerHTML = '';
            document.getElementById('guides-container-no-rulers').innerHTML = '';

            // Render to current active guides container
            state.guides.forEach(guide => {
                const guideEl = document.createElement('div');
                guideEl.className = 'guide-line ' + guide.orientation;
                guideEl.dataset.guideId = guide.id;

                if (guide.orientation === 'horizontal') {
                    guideEl.style.top = guide.position + 'px';
                } else {
                    guideEl.style.left = guide.position + 'px';
                }

                // Add drag functionality
                guideEl.addEventListener('mousedown', (e) => startGuideDrag(e, guide));

                // Double click to delete
                guideEl.addEventListener('dblclick', () => deleteGuide(guide.id));

                guidesContainer.appendChild(guideEl);
            });
        }

        function startGuideDrag(e, guide) {
            e.preventDefault();
            e.stopPropagation();

            const guideEl = e.target;
            guideEl.classList.add('dragging');

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'guide-tooltip';
            tooltip.id = 'guide-tooltip-drag';
            document.body.appendChild(tooltip);

            const moveGuide = (moveE) => {
                const canvasRect = canvas.getBoundingClientRect();
                let newPosition;

                if (guide.orientation === 'horizontal') {
                    newPosition = moveE.clientY - canvasRect.top;
                    newPosition = Math.max(0, Math.min(newPosition, canvas.offsetHeight));
                } else {
                    newPosition = moveE.clientX - canvasRect.left;
                    newPosition = Math.max(0, Math.min(newPosition, canvas.offsetWidth));
                }

                guide.position = newPosition;
                renderGuides();

                // Update tooltip
                tooltip.textContent = Math.round(newPosition) + 'px';
                tooltip.style.left = (moveE.clientX + 15) + 'px';
                tooltip.style.top = (moveE.clientY + 15) + 'px';
            };

            const stopGuide = () => {
                document.removeEventListener('mousemove', moveGuide);
                document.removeEventListener('mouseup', stopGuide);
                guideEl.classList.remove('dragging');
                tooltip.remove();

                // Check if dragged outside canvas
                if (guide.orientation === 'horizontal') {
                    if (guide.position <= 0 || guide.position >= canvas.offsetHeight) {
                        deleteGuide(guide.id);
                    }
                } else {
                    if (guide.position <= 0 || guide.position >= canvas.offsetWidth) {
                        deleteGuide(guide.id);
                    }
                }
            };

            document.addEventListener('mousemove', moveGuide);
            document.addEventListener('mouseup', stopGuide);
        }

        function deleteGuide(guideId) {
            state.guides = state.guides.filter(g => g.id !== guideId);
            renderGuides();
            updateRulerCorner();
            showToast('Guia eliminada');
        }

        function clearAllGuides() {
            if (state.guides.length === 0) return;
            state.guides = [];
            renderGuides();
            updateRulerCorner();
            showToast('Todas las guias eliminadas');
        }

        function updateRulerCorner() {
            rulerCorner.classList.toggle('guides-active', state.guides.length > 0);
        }

        function snapToGuide(value, axis) {
            if (!state.snapToGuides || state.guides.length === 0) return value;

            const relevantGuides = state.guides.filter(g =>
                (axis === 'x' && g.orientation === 'vertical') ||
                (axis === 'y' && g.orientation === 'horizontal')
            );

            for (const guide of relevantGuides) {
                if (Math.abs(value - guide.position) <= state.guideSnapDistance) {
                    return guide.position;
                }
            }

            return value;
        }

        function applySnapping(x, y, width, height) {
            let newX = snapToGrid(x);
            let newY = snapToGrid(y);

            // Snap to guides (element edges)
            newX = snapToGuide(newX, 'x');
            newY = snapToGuide(newY, 'y');

            // Also check right and bottom edges
            const rightEdge = snapToGuide(newX + width, 'x');
            if (rightEdge !== newX + width) {
                newX = rightEdge - width;
            }

            const bottomEdge = snapToGuide(newY + height, 'y');
            if (bottomEdge !== newY + height) {
                newY = bottomEdge - height;
            }

            // Check center
            const centerX = snapToGuide(newX + width / 2, 'x');
            if (centerX !== newX + width / 2) {
                newX = centerX - width / 2;
            }

            const centerY = snapToGuide(newY + height / 2, 'y');
            if (centerY !== newY + height / 2) {
                newY = centerY - height / 2;
            }

            return { x: newX, y: newY };
        }

        // ==========================================
        // ZOOM AND PAN
        // ==========================================
        function handleZoom(e) {
            e.preventDefault();

            const delta = e.deltaY > 0 ? -state.zoomStep : state.zoomStep;
            const newZoom = Math.max(state.zoomMin, Math.min(state.zoomMax, state.zoom + delta));

            if (newZoom !== state.zoom) {
                // Posición del mouse relativa al contenedor
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Centro del contenedor
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                // Posición del mouse relativa al centro (punto de transformación)
                const offsetX = mouseX - centerX;
                const offsetY = mouseY - centerY;

                // Calcular el punto "mundo" bajo el cursor antes del zoom
                // El viewport se transforma desde el centro, así que:
                // worldX = (offsetX - panX) / zoom
                const worldX = (offsetX - state.panX) / state.zoom;
                const worldY = (offsetY - state.panY) / state.zoom;

                // Aplicar nuevo zoom
                state.zoom = newZoom;

                // Calcular nuevo pan para que el mismo punto mundo quede bajo el cursor
                // offsetX = worldX * newZoom + newPanX
                // newPanX = offsetX - worldX * newZoom
                state.panX = offsetX - worldX * state.zoom;
                state.panY = offsetY - worldY * state.zoom;

                applyZoomAndPan();
            }
        }

        function handlePanStart(e) {
            // Solo iniciar pan con botón medio del mouse
            if (e.button !== 1) return;

            e.preventDefault();
            state.isPanning = true;
            canvasContainer.classList.add('panning');

            const startX = e.clientX;
            const startY = e.clientY;
            const startPanX = state.panX;
            const startPanY = state.panY;

            const handlePanMove = (e) => {
                if (!state.isPanning) return;

                state.panX = startPanX + (e.clientX - startX);
                state.panY = startPanY + (e.clientY - startY);
                applyZoomAndPan();
            };

            const handlePanEnd = () => {
                state.isPanning = false;
                canvasContainer.classList.remove('panning');
                document.removeEventListener('mousemove', handlePanMove);
                document.removeEventListener('mouseup', handlePanEnd);
            };

            document.addEventListener('mousemove', handlePanMove);
            document.addEventListener('mouseup', handlePanEnd);
        }

        function applyZoomAndPan() {
            canvasViewport.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
            updateZoomDisplay();
        }

        function updateZoomDisplay() {
            zoomLevelDisplay.textContent = Math.round(state.zoom * 100) + '%';
        }

        function zoomIn() {
            state.zoom = Math.min(state.zoomMax, state.zoom + state.zoomStep);
            applyZoomAndPan();
        }

        function zoomOut() {
            state.zoom = Math.max(state.zoomMin, state.zoom - state.zoomStep);
            applyZoomAndPan();
        }

        function zoomReset() {
            state.zoom = 1;
            state.panX = 0;
            state.panY = 0;
            applyZoomAndPan();
        }

        function zoomFit() {
            const containerRect = canvasContainer.getBoundingClientRect();
            const canvasWidth = state.orientation === 'landscape' ? 842 : 595;
            const canvasHeight = state.orientation === 'landscape' ? 595 : 842;

            // Considerar espacio extra para reglas si están visibles
            const rulerOffset = state.rulersVisible ? 25 : 0;
            const padding = 40; // Margen

            const availableWidth = containerRect.width - padding * 2;
            const availableHeight = containerRect.height - padding * 2;

            const scaleX = availableWidth / (canvasWidth + rulerOffset);
            const scaleY = availableHeight / (canvasHeight + rulerOffset);

            state.zoom = Math.min(scaleX, scaleY, 1); // No hacer zoom mayor a 100%
            state.panX = 0;
            state.panY = 0;
            applyZoomAndPan();
        }

        // ==========================================
        // DELETE
        // ==========================================
        function deleteSelected() {
            console.log('deleteSelected llamado. selectedId:', state.selectedId, 'selectedIds:', state.selectedIds);

            if (!state.selectedId && state.selectedIds.length === 0) {
                showToast('No hay elemento seleccionado');
                return;
            }

            // Si hay múltiples seleccionados, eliminar todos
            if (state.selectedIds.length > 1) {
                const idsToDelete = state.selectedIds.map(id => Number(id));
                console.log('Eliminando múltiples elementos:', idsToDelete);

                const beforeCount = state.elements.length;
                state.elements = state.elements.filter(e => !idsToDelete.includes(Number(e.id)));
                const afterCount = state.elements.length;

                const eliminados = beforeCount - afterCount;
                state.selectedId = null;
                state.selectedIds = [];
                saveState();
                renderElements();
                updatePropertiesPanel();
                showToast(`${eliminados} elemento(s) eliminado(s)`);
                return;
            }

            // Eliminar elemento único
            const idToDelete = Number(state.selectedId);
            console.log('Eliminando elemento único con ID:', idToDelete);
            console.log('Elementos antes:', state.elements.map(e => ({ id: e.id, tipo: typeof e.id })));

            const beforeCount = state.elements.length;
            state.elements = state.elements.filter(e => Number(e.id) !== idToDelete);
            const afterCount = state.elements.length;

            if (beforeCount === afterCount) {
                console.error('No se pudo eliminar. ID buscado:', idToDelete);
                console.error('IDs disponibles:', state.elements.map(e => e.id));
                showToast('Error al eliminar - ver consola');
                return;
            }

            state.selectedId = null;
            state.selectedIds = [];
            saveState();
            renderElements();
            updatePropertiesPanel();
            showToast('Elemento eliminado');
            console.log('Eliminación exitosa. Elementos restantes:', state.elements.length);
        }

        // ==========================================
        // KEYBOARD SHORTCUTS
        // ==========================================
        function handleKeyDown(e) {
            // Don't trigger if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.ctrlKey && e.shiftKey && e.key === 'G') {
                e.preventDefault();
                ungroupElements();
            } else if (e.ctrlKey && !e.shiftKey && e.key === 'g') {
                e.preventDefault();
                groupElements();
            } else if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                copyFormat();
            } else if (e.ctrlKey && e.shiftKey && e.key === 'V') {
                e.preventDefault();
                pasteFormat();
            } else if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            } else if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveProject();
            } else if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                duplicateSelected();
            } else if (e.key === 'Delete' || e.key === 'Backspace') {
                deleteSelected();
            } else if (e.key === 'g') {
                toggleGrid();
            } else if (e.key === 's' && !e.ctrlKey && !e.shiftKey) {
                toggleSnap();
            } else if (e.key === 'S' && e.shiftKey && !e.ctrlKey) {
                toggleSnapToGuides();
            } else if (e.key === 'r' && !e.ctrlKey) {
                toggleRulers();
            } else if (e.key === '+' || e.key === '=') {
                e.preventDefault();
                zoomIn();
            } else if (e.key === '-') {
                e.preventDefault();
                zoomOut();
            } else if (e.key === '0' && !e.ctrlKey) {
                e.preventDefault();
                zoomReset();
            } else if (e.key === 'f' && !e.ctrlKey) {
                e.preventDefault();
                zoomFit();
            } else if (e.key === 'Escape') {
                selectElement(null);
            }

            // Arrow keys for nudge
            if (state.selectedId && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                const el = getSelectedElement();
                if (el) {
                    const step = e.shiftKey ? 10 : 1;
                    if (e.key === 'ArrowUp') el.y -= step;
                    if (e.key === 'ArrowDown') el.y += step;
                    if (e.key === 'ArrowLeft') el.x -= step;
                    if (e.key === 'ArrowRight') el.x += step;
                    renderElements();
                    updatePropertiesPanel();
                    saveState();
                }
            }
        }

        function duplicateSelected() {
            if (!state.selectedId) return;
            const el = getSelectedElement();
            if (!el) return;

            const newEl = { ...el, id: state.nextId++, x: el.x + 20, y: el.y + 20, groupId: null };
            state.elements.push(newEl);
            saveState();
            renderElements();
            selectElement(newEl.id);
            showToast('Elemento duplicado');
        }

        // ==========================================
        // GROUPING
        // ==========================================
        function groupElements() {
            if (state.selectedIds.length < 2) {
                showToast('Selecciona al menos 2 elementos para agrupar');
                return;
            }

            const groupId = state.nextGroupId++;
            const groupName = 'Grupo ' + groupId;

            // Assign groupId to all selected elements
            state.selectedIds.forEach(id => {
                const el = state.elements.find(e => Number(e.id) === Number(id));
                if (el) {
                    el.groupId = groupId;
                }
            });

            // Store group info
            state.groups[groupId] = {
                id: groupId,
                name: groupName,
                elementIds: [...state.selectedIds]
            };

            saveState();
            renderElements();
            updateLayersList();
            updateGroupButtons();
            showToast('Elementos agrupados (' + state.selectedIds.length + ')');
        }

        function ungroupElements() {
            if (state.selectedIds.length === 0) {
                showToast('Selecciona elementos para desagrupar');
                return;
            }

            // Find all groups that have selected elements
            const groupsToRemove = new Set();

            state.selectedIds.forEach(id => {
                const el = state.elements.find(e => Number(e.id) === Number(id));
                if (el && el.groupId) {
                    groupsToRemove.add(el.groupId);
                }
            });

            if (groupsToRemove.size === 0) {
                showToast('Los elementos seleccionados no estan agrupados');
                return;
            }

            // Remove groupId from all elements in those groups
            groupsToRemove.forEach(groupId => {
                state.elements.forEach(el => {
                    if (el.groupId === groupId) {
                        el.groupId = null;
                    }
                });
                delete state.groups[groupId];
            });

            saveState();
            renderElements();
            updateLayersList();
            updateGroupButtons();
            showToast('Elementos desagrupados');
        }

        function updateGroupButtons() {
            const btnGroup = document.getElementById('btn-group');
            const btnUngroup = document.getElementById('btn-ungroup');

            // Enable group button if 2+ elements selected
            btnGroup.disabled = state.selectedIds.length < 2;

            // Enable ungroup button if any selected element is in a group
            const hasGroupedElement = state.selectedIds.some(id => {
                const el = state.elements.find(e => Number(e.id) === Number(id));
                return el && el.groupId;
            });
            btnUngroup.disabled = !hasGroupedElement;
        }

        function getGroupElements(groupId) {
            return state.elements.filter(el => el.groupId === groupId);
        }

        function selectGroup(groupId) {
            const groupElements = getGroupElements(groupId);
            if (groupElements.length === 0) return;

            state.selectedIds = groupElements.map(el => Number(el.id));
            state.selectedId = state.selectedIds[0];

            // Update visual selection
            const allCanvasElements = [
                ...document.getElementById('canvas-no-rulers').querySelectorAll('.canvas-element'),
                ...document.getElementById('canvas').querySelectorAll('.canvas-element')
            ];
            allCanvasElements.forEach(el => {
                const elId = Number(el.dataset.id);
                const isSelected = state.selectedIds.includes(elId);
                el.classList.toggle('selected', isSelected);
            });

            updatePropertiesPanel();
            updateLayersList();
            updateAlignButtons();
            updateGroupButtons();
        }

        function copyFormat() {
            if (!state.selectedId) {
                showToast('Selecciona un elemento primero');
                return;
            }
            const el = getSelectedElement();
            if (!el) return;

            // Copiar propiedades de formato según el tipo
            if (el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph') {
                state.copiedFormat = {
                    sourceType: 'text',
                    font: el.font,
                    size: el.size,
                    color: el.color,
                    align: el.align,
                    style: el.style,
                    lineHeight: el.lineHeight
                };
            } else if (el.type === 'line' || el.type === 'line-firma') {
                state.copiedFormat = {
                    sourceType: 'line',
                    color: el.color,
                    thickness: el.thickness,
                    lineStyle: el.lineStyle
                };
            } else if (el.type === 'separator') {
                state.copiedFormat = {
                    sourceType: 'separator',
                    color: el.color,
                    thickness: el.thickness,
                    separatorStyle: el.separatorStyle
                };
            } else {
                showToast('Este tipo de elemento no tiene formato copiable');
                return;
            }

            // Activar botón de pegar
            document.getElementById('btn-paste-format').disabled = false;
            document.getElementById('btn-copy-format').classList.add('has-format');
            showToast('Formato copiado - selecciona otro elemento y pega');
        }

        function pasteFormat() {
            if (!state.copiedFormat) {
                showToast('No hay formato copiado');
                return;
            }
            if (!state.selectedId) {
                showToast('Selecciona un elemento destino');
                return;
            }

            const el = getSelectedElement();
            if (!el) return;

            const format = state.copiedFormat;

            // Aplicar formato según compatibilidad
            if (format.sourceType === 'text' && (el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph')) {
                el.font = format.font;
                el.size = format.size;
                el.color = format.color;
                el.align = format.align;
                el.style = format.style;
                el.lineHeight = format.lineHeight;
                showToast('Formato aplicado');
            } else if (format.sourceType === 'line' && (el.type === 'line' || el.type === 'line-firma')) {
                el.color = format.color;
                el.thickness = format.thickness;
                el.lineStyle = format.lineStyle;
                showToast('Formato aplicado');
            } else if (format.sourceType === 'separator' && el.type === 'separator') {
                el.color = format.color;
                el.thickness = format.thickness;
                el.separatorStyle = format.separatorStyle;
                showToast('Formato aplicado');
            } else if (format.color && (el.type === 'line' || el.type === 'line-firma' || el.type === 'separator' || el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph')) {
                // Al menos copiar el color si son tipos diferentes
                el.color = format.color;
                showToast('Color aplicado (tipos diferentes)');
            } else {
                showToast('Tipos de elemento incompatibles');
                return;
            }

            saveState();
            renderElements();
            updatePropertiesPanel();
        }

        function clearCopiedFormat() {
            state.copiedFormat = null;
            document.getElementById('btn-paste-format').disabled = true;
            document.getElementById('btn-copy-format').classList.remove('has-format');
        }

        // ==========================================
        // ALIGNMENT FUNCTIONS
        // ==========================================
        function getCanvasSize() {
            return state.orientation === 'landscape'
                ? { width: 842, height: 595 }
                : { width: 595, height: 842 };
        }

        function getSelectedElements() {
            return state.elements.filter(el => state.selectedIds.some(sid => Number(sid) === Number(el.id)));
        }

        // Alineación al Canvas
        function alignCanvasLeft() {
            const elements = getSelectedElements();
            elements.forEach(el => { el.x = 0; });
            saveState();
            renderElements();
            showToast('Alineado a la izquierda');
        }

        function alignCanvasCenterH() {
            const canvasSize = getCanvasSize();
            const elements = getSelectedElements();
            elements.forEach(el => {
                el.x = (canvasSize.width - el.width) / 2;
            });
            saveState();
            renderElements();
            showToast('Centrado horizontalmente');
        }

        function alignCanvasRight() {
            const canvasSize = getCanvasSize();
            const elements = getSelectedElements();
            elements.forEach(el => {
                el.x = canvasSize.width - el.width;
            });
            saveState();
            renderElements();
            showToast('Alineado a la derecha');
        }

        function alignCanvasTop() {
            const elements = getSelectedElements();
            elements.forEach(el => { el.y = 0; });
            saveState();
            renderElements();
            showToast('Alineado arriba');
        }

        function alignCanvasCenterV() {
            const canvasSize = getCanvasSize();
            const elements = getSelectedElements();
            elements.forEach(el => {
                el.y = (canvasSize.height - el.height) / 2;
            });
            saveState();
            renderElements();
            showToast('Centrado verticalmente');
        }

        function alignCanvasBottom() {
            const canvasSize = getCanvasSize();
            const elements = getSelectedElements();
            elements.forEach(el => {
                el.y = canvasSize.height - el.height;
            });
            saveState();
            renderElements();
            showToast('Alineado abajo');
        }

        // Alineación entre elementos (el último seleccionado es la referencia)
        function getAlignReference() {
            // El último seleccionado (state.selectedId) es la referencia que no se mueve
            return getSelectedElement();
        }

        function alignElementsLeft() {
            const elements = getSelectedElements();
            if (elements.length < 2) return;
            const ref = getAlignReference();
            if (!ref) return;

            elements.forEach(el => {
                if (el.id !== ref.id) {
                    el.x = ref.x;
                }
            });
            saveState();
            renderElements();
            showToast('Alineados a la izquierda del elemento referencia');
        }

        function alignElementsCenterH() {
            const elements = getSelectedElements();
            if (elements.length < 2) return;
            const ref = getAlignReference();
            if (!ref) return;

            const refCenterX = ref.x + ref.width / 2;
            elements.forEach(el => {
                if (el.id !== ref.id) {
                    el.x = refCenterX - el.width / 2;
                }
            });
            saveState();
            renderElements();
            showToast('Centrados horizontalmente con el elemento referencia');
        }

        function alignElementsRight() {
            const elements = getSelectedElements();
            if (elements.length < 2) return;
            const ref = getAlignReference();
            if (!ref) return;

            const refRight = ref.x + ref.width;
            elements.forEach(el => {
                if (el.id !== ref.id) {
                    el.x = refRight - el.width;
                }
            });
            saveState();
            renderElements();
            showToast('Alineados a la derecha del elemento referencia');
        }

        function alignElementsTop() {
            const elements = getSelectedElements();
            if (elements.length < 2) return;
            const ref = getAlignReference();
            if (!ref) return;

            elements.forEach(el => {
                if (el.id !== ref.id) {
                    el.y = ref.y;
                }
            });
            saveState();
            renderElements();
            showToast('Alineados arriba del elemento referencia');
        }

        function alignElementsCenterV() {
            const elements = getSelectedElements();
            if (elements.length < 2) return;
            const ref = getAlignReference();
            if (!ref) return;

            const refCenterY = ref.y + ref.height / 2;
            elements.forEach(el => {
                if (el.id !== ref.id) {
                    el.y = refCenterY - el.height / 2;
                }
            });
            saveState();
            renderElements();
            showToast('Centrados verticalmente con el elemento referencia');
        }

        function alignElementsBottom() {
            const elements = getSelectedElements();
            if (elements.length < 2) return;
            const ref = getAlignReference();
            if (!ref) return;

            const refBottom = ref.y + ref.height;
            elements.forEach(el => {
                if (el.id !== ref.id) {
                    el.y = refBottom - el.height;
                }
            });
            saveState();
            renderElements();
            showToast('Alineados abajo del elemento referencia');
        }

        // Distribución
        function distributeHorizontally() {
            const elements = getSelectedElements();
            if (elements.length < 3) return;

            // Ordenar por posición X
            elements.sort((a, b) => a.x - b.x);

            const first = elements[0];
            const last = elements[elements.length - 1];
            const totalSpace = (last.x + last.width) - first.x;
            const totalElementWidth = elements.reduce((sum, el) => sum + el.width, 0);
            const gap = (totalSpace - totalElementWidth) / (elements.length - 1);

            let currentX = first.x;
            elements.forEach(el => {
                el.x = currentX;
                currentX += el.width + gap;
            });

            saveState();
            renderElements();
            showToast('Distribuido horizontalmente');
        }

        function distributeVertically() {
            const elements = getSelectedElements();
            if (elements.length < 3) return;

            // Ordenar por posición Y
            elements.sort((a, b) => a.y - b.y);

            const first = elements[0];
            const last = elements[elements.length - 1];
            const totalSpace = (last.y + last.height) - first.y;
            const totalElementHeight = elements.reduce((sum, el) => sum + el.height, 0);
            const gap = (totalSpace - totalElementHeight) / (elements.length - 1);

            let currentY = first.y;
            elements.forEach(el => {
                el.y = currentY;
                currentY += el.height + gap;
            });

            saveState();
            renderElements();
            showToast('Distribuido verticalmente');
        }

        function toggleShortcuts() {
            document.getElementById('shortcuts-panel').classList.toggle('visible');
        }

        // ==========================================
        // BACKGROUND
        // ==========================================
        function handleBackgroundUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Guardar nombre original del archivo
            state.backgroundFilename = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.background = e.target.result;
                const bgUrl = `url(${state.background})`;
                document.getElementById('canvas').style.backgroundImage = bgUrl;
                document.getElementById('canvas-no-rulers').style.backgroundImage = bgUrl;
                saveToLocalStorage();

                // Si hay slug definido, subir al servidor
                if (state.templateSlug) {
                    uploadBackgroundToServer(state.background, state.templateSlug, state.backgroundFilename);
                } else {
                    showToast(`Fondo "${state.backgroundFilename}" cargado (sin slug, no se sube al servidor)`);
                }
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function uploadBackgroundToServer(imageData, slug, originalFilename) {
            try {
                showToast('Subiendo fondo al servidor...');

                const response = await fetch('upload-background.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        slug: slug,
                        image: imageData,
                        filename: originalFilename
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Actualizar el filename con el nombre sanitizado del servidor
                    state.backgroundFilename = result.filename;
                    showToast(`Fondo guardado: ${result.path}`);
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error uploading background:', error);
                showToast('Error al subir el fondo al servidor', 'error');
            }
        }

        // ==========================================
        // PROJECT SAVE/LOAD
        // ==========================================
        function saveProject() {
            const project = {
                name: state.templateName,
                slug: state.templateSlug,
                orientation: state.orientation,
                background: state.background,
                backgroundFilename: state.backgroundFilename,
                elements: state.elements,
                nextId: state.nextId,
                guides: state.guides,
                // Configuración de visualización
                viewSettings: {
                    rulersVisible: state.rulersVisible,
                    gridVisible: state.gridVisible,
                    snapEnabled: state.snapEnabled,
                    snapToGuides: state.snapToGuides
                },
                // Datos del cliente demo
                previewData: {
                    images: state.previewData.images,
                    values: state.previewData.values
                },
                previewMode: state.previewMode
            };

            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.templateName.replace(/\s+/g, '_')}_project.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Proyecto guardado');
        }

        function handleLoadProject(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const project = JSON.parse(e.target.result);
                    state.templateName = project.name || 'Template';
                    state.templateSlug = project.slug || '';
                    state.orientation = project.orientation || 'landscape';
                    state.background = project.background;
                    state.backgroundFilename = project.backgroundFilename || null;
                    state.elements = project.elements || [];
                    state.nextId = project.nextId || 1;
                    state.guides = project.guides || [];
                    state.selectedId = null;
                    state.history = [];
                    state.historyIndex = -1;

                    // Restaurar configuración de visualización
                    if (project.viewSettings) {
                        state.gridVisible = project.viewSettings.gridVisible || false;
                        state.snapEnabled = project.viewSettings.snapEnabled || false;
                        state.snapToGuides = project.viewSettings.snapToGuides || false;

                        // Aplicar estados de los botones
                        document.getElementById('btn-grid').classList.toggle('active', state.gridVisible);
                        document.getElementById('btn-snap').classList.toggle('active', state.snapEnabled);
                        document.getElementById('btn-snap-guides').classList.toggle('active', state.snapToGuides);

                        // Manejar reglas (toggle si es diferente al estado actual)
                        const shouldShowRulers = project.viewSettings.rulersVisible || false;
                        if (shouldShowRulers !== state.rulersVisible) {
                            toggleRulers();
                        }
                    }

                    // Restaurar datos del cliente demo
                    if (project.previewData) {
                        state.previewData.images = project.previewData.images || {
                            logo_1: null, logo_2: null, firma_1: null, firma_2: null
                        };
                        state.previewData.values = project.previewData.values || state.previewData.values;

                        // Actualizar campos del formulario de preview
                        updatePreviewFormFromState();
                    }

                    // Restaurar modo preview
                    if (project.previewMode !== undefined) {
                        state.previewMode = project.previewMode;
                        document.getElementById('btn-preview-mode').classList.toggle('active', state.previewMode);
                    }

                    updateCanvasOrientation();
                    if (state.background) {
                        const bgUrl = `url(${state.background})`;
                        document.getElementById('canvas').style.backgroundImage = bgUrl;
                        document.getElementById('canvas-no-rulers').style.backgroundImage = bgUrl;
                    } else {
                        document.getElementById('canvas').style.backgroundImage = '';
                        document.getElementById('canvas-no-rulers').style.backgroundImage = '';
                    }

                    // Aplicar visibilidad de grilla
                    canvasGrid.classList.toggle('visible', state.gridVisible);

                    saveState();
                    renderElements();
                    renderGuides();
                    updateRulerCorner();
                    updatePropertiesPanel();
                    showToast('Proyecto cargado');
                } catch (err) {
                    console.error('Error loading project:', err);
                    showToast('Error al cargar el proyecto');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function updatePreviewFormFromState() {
            // Actualizar imágenes en el formulario
            const imageFields = ['logo_1', 'logo_2', 'firma_1', 'firma_2'];
            const fieldMapping = {
                'logo_1': { img: 'preview-logo1-img', text: 'preview-logo1-text', box: 'preview-logo1-box' },
                'logo_2': { img: 'preview-logo2-img', text: 'preview-logo2-text', box: 'preview-logo2-box' },
                'firma_1': { img: 'preview-firma1-img', text: 'preview-firma1-text', box: 'preview-firma1-box' },
                'firma_2': { img: 'preview-firma2-img', text: 'preview-firma2-text', box: 'preview-firma2-box' }
            };

            imageFields.forEach(field => {
                const mapping = fieldMapping[field];
                const imgEl = document.getElementById(mapping.img);
                const textEl = document.getElementById(mapping.text);
                const boxEl = document.getElementById(mapping.box);

                if (state.previewData.images[field]) {
                    imgEl.src = state.previewData.images[field];
                    imgEl.style.display = 'block';
                    textEl.style.display = 'none';
                    boxEl.classList.add('has-image');
                } else {
                    imgEl.style.display = 'none';
                    textEl.style.display = 'block';
                    boxEl.classList.remove('has-image');
                }
            });

            // Actualizar valores de texto
            const valueMapping = {
                'nombre_completo': 'sim-nombre',
                'dni': 'sim-dni',
                'nombre_curso': 'sim-curso',
                'fecha': 'sim-fecha',
                'carga_horaria': 'sim-horas',
                'codigo_validacion': 'sim-codigo',
                'nombre_institucion': 'sim-institucion',
                'firmante_1_nombre': 'sim-firmante1-nombre',
                'firmante_1_cargo': 'sim-firmante1-cargo',
                'firmante_2_nombre': 'sim-firmante2-nombre',
                'firmante_2_cargo': 'sim-firmante2-cargo'
            };

            Object.entries(valueMapping).forEach(([stateKey, inputId]) => {
                const input = document.getElementById(inputId);
                if (input && state.previewData.values[stateKey]) {
                    input.value = state.previewData.values[stateKey];
                }
            });
        }

        function saveToLocalStorage() {
            try {
                // No guardar la imagen de fondo si es muy grande (> 500KB)
                let backgroundToSave = state.background;
                if (backgroundToSave && backgroundToSave.length > 500000) {
                    console.warn('Imagen de fondo muy grande, no se guardará en localStorage');
                    backgroundToSave = null;
                }

                // No guardar imágenes de preview
                const previewDataToSave = {
                    images: {}, // No guardar las imágenes en localStorage
                    values: state.previewData.values
                };

                const data = {
                    templateName: state.templateName,
                    templateSlug: state.templateSlug,
                    orientation: state.orientation,
                    background: backgroundToSave,
                    backgroundFilename: state.backgroundFilename,
                    elements: state.elements,
                    guides: state.guides,
                    nextId: state.nextId,
                    viewSettings: {
                        rulersVisible: state.rulersVisible,
                        gridVisible: state.gridVisible,
                        snapEnabled: state.snapEnabled,
                        snapToGuides: state.snapToGuides
                    },
                    previewData: previewDataToSave,
                    previewMode: state.previewMode
                };
                localStorage.setItem('verumax_template_editor', JSON.stringify(data));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn('localStorage lleno - limpiando datos antiguos...');
                    // Intentar limpiar y guardar solo lo esencial
                    try {
                        localStorage.removeItem('verumax_template_editor');
                        const minimalData = {
                            templateName: state.templateName,
                            orientation: state.orientation,
                            background: null, // No guardar imagen
                            elements: state.elements,
                            guides: [],
                            nextId: state.nextId,
                            viewSettings: {},
                            previewData: { images: {}, values: {} },
                            previewMode: false
                        };
                        localStorage.setItem('verumax_template_editor', JSON.stringify(minimalData));
                        showToast('Espacio limitado - guardado parcial');
                    } catch (e2) {
                        console.error('No se pudo guardar en localStorage:', e2);
                        showToast('Error: localStorage lleno');
                    }
                } else {
                    console.error('Error guardando en localStorage:', e);
                }
            }
        }

        function clearLocalStorage() {
            if (confirm('¿Limpiar todo el almacenamiento local del editor?\n\nEsto eliminará el proyecto guardado automáticamente pero NO afectará archivos guardados manualmente.')) {
                localStorage.removeItem('verumax_template_editor');
                localStorage.removeItem('verumax_client_profiles');
                showToast('Almacenamiento limpiado');
                console.log('localStorage limpiado');
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('verumax_template_editor');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.templateName = data.templateName || 'Nuevo Template';
                    state.templateSlug = data.templateSlug || '';
                    state.orientation = data.orientation || 'landscape';
                    state.background = data.background;
                    state.backgroundFilename = data.backgroundFilename || null;
                    state.elements = data.elements || [];
                    state.guides = data.guides || [];
                    state.nextId = data.nextId || 1;

                    // Restaurar configuración de visualización
                    if (data.viewSettings) {
                        state.gridVisible = data.viewSettings.gridVisible || false;
                        state.snapEnabled = data.viewSettings.snapEnabled || false;
                        state.snapToGuides = data.viewSettings.snapToGuides || false;

                        document.getElementById('btn-grid').classList.toggle('active', state.gridVisible);
                        document.getElementById('btn-snap').classList.toggle('active', state.snapEnabled);
                        document.getElementById('btn-snap-guides').classList.toggle('active', state.snapToGuides);

                        // Manejar reglas después de que el DOM esté listo
                        if (data.viewSettings.rulersVisible) {
                            setTimeout(() => toggleRulers(), 100);
                        }
                    }

                    // Restaurar datos del cliente demo
                    if (data.previewData) {
                        state.previewData = data.previewData;
                        updatePreviewFormFromState();
                    }

                    // Restaurar modo preview
                    if (data.previewMode !== undefined) {
                        state.previewMode = data.previewMode;
                        document.getElementById('btn-preview-mode').classList.toggle('active', state.previewMode);
                    }

                    updateCanvasOrientation();
                    if (state.background) {
                        const bgUrl = `url(${state.background})`;
                        document.getElementById('canvas').style.backgroundImage = bgUrl;
                        document.getElementById('canvas-no-rulers').style.backgroundImage = bgUrl;
                    }

                    canvasGrid.classList.toggle('visible', state.gridVisible);
                    renderElements();
                    renderGuides();
                    updateRulerCorner();
                } catch (e) {
                    console.error('Error loading from localStorage', e);
                }
            }
        }

        // ==========================================
        // NEW TEMPLATE
        // ==========================================
        function createNewTemplate() {
            state.templateName = document.getElementById('new-name').value || 'Nuevo Template';
            state.templateSlug = (document.getElementById('new-slug').value || '').toLowerCase().replace(/[^a-z0-9_-]/g, '_');
            state.orientation = document.getElementById('new-orientation').value;
            state.background = null;
            state.backgroundFilename = null;
            state.elements = [];
            state.guides = [];
            state.selectedId = null;
            state.nextId = 1;
            state.history = [];
            state.historyIndex = -1;

            canvas.style.backgroundImage = '';
            document.getElementById('canvas').style.backgroundImage = '';
            document.getElementById('canvas-no-rulers').style.backgroundImage = '';
            updateCanvasOrientation();
            saveState();
            renderElements();
            renderGuides();
            updateRulerCorner();
            updatePropertiesPanel();
            closeModal('modal-new');
            showToast('Nuevo template creado');
        }

        function updateCanvasOrientation() {
            // Update both canvases
            document.getElementById('canvas').classList.remove('landscape', 'portrait');
            document.getElementById('canvas').classList.add(state.orientation);
            document.getElementById('canvas-no-rulers').classList.remove('landscape', 'portrait');
            document.getElementById('canvas-no-rulers').classList.add(state.orientation);

            const size = state.orientation === 'landscape' ? '842 x 595' : '595 x 842';
            const slugInfo = state.templateSlug ? ` [${state.templateSlug}]` : '';
            statusInfo.textContent = `${state.templateName}${slugInfo} | A4 ${state.orientation === 'landscape' ? 'Landscape' : 'Portrait'} (${size} px)`;

            // Re-render rulers if visible
            if (state.rulersVisible) {
                renderRulers();
            }
        }

        // ==========================================
        // EXPORT JSON
        // ==========================================
        function exportJSON() {
            // Convert pixel positions to mm for PDF generation
            const pxToMm = (px) => Math.round(px * 0.264583 * 10) / 10;

            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;

            // Filtrar elementos que estén completamente fuera del canvas
            const validElements = state.elements.filter(el => {
                const isInside = el.x < canvasWidth && el.y < canvasHeight &&
                                 (el.x + el.width) > 0 && (el.y + el.height) > 0;
                return isInside;
            });

            // Avisar si se excluyeron elementos
            const excludedCount = state.elements.length - validElements.length;
            if (excludedCount > 0) {
                showToast(`⚠️ ${excludedCount} elemento(s) fuera del canvas fueron excluidos`);
            }

            const config = {
                name: state.templateName,
                slug: state.templateSlug || null,
                canvas: {
                    width: state.orientation === 'landscape' ? 297 : 210,
                    height: state.orientation === 'landscape' ? 210 : 297,
                    orientation: state.orientation,
                    background: state.background ? (state.backgroundFilename || 'fondo.jpg') : null
                },
                elements: validElements.map(el => {
                    const base = {
                        type: el.type,
                        label: el.label,
                        x: pxToMm(el.x),
                        y: pxToMm(el.y),
                        width: pxToMm(el.width),
                        height: pxToMm(el.height)
                    };

                    if (el.type === 'text' || el.type === 'title' || el.type === 'text-custom' || el.type === 'paragraph') {
                        const result = {
                            ...base,
                            variable: el.variable || null,
                            text: el.variable ? null : el.text,
                            font: el.font,
                            size: Math.round(el.size * 0.75), // px to pt
                            color: el.color,
                            align: el.align,
                            style: el.style
                        };
                        // Incluir text_key si está definido (para internacionalización)
                        if (el.text_key) {
                            result.text_key = el.text_key;
                        }
                        // Para párrafos y text-custom, incluir también los textos alternativos y sus text_key
                        if (el.type === 'paragraph' || el.type === 'text-custom') {
                            if (el.text_finalizacion) {
                                result.text_finalizacion = el.text_finalizacion;
                            }
                            if (el.text_key_finalizacion) {
                                result.text_key_finalizacion = el.text_key_finalizacion;
                            }
                            if (el.text_docente) {
                                result.text_docente = el.text_docente;
                            }
                            if (el.text_key_docente) {
                                result.text_key_docente = el.text_key_docente;
                            }
                        }
                        return result;
                    } else if (el.type === 'image-custom') {
                        // Imagen personalizada con ruta src
                        return {
                            ...base,
                            type: 'image',  // Exportar como 'image' para compatibilidad con el PDF
                            src: el.src || '',
                            rotation: el.rotation || 0,
                            opacity: el.opacity || 1
                        };
                    } else if (el.type === 'stamp') {
                        return {
                            ...base,
                            text: el.text || '{{fecha_sello}}',
                            color: el.color || '#1e40af',
                            size: Math.round((el.size || 12) * 0.75), // px to pt
                            rotation: el.rotation || 0,
                            opacity: el.opacity || 0.85,
                            borderWidth: el.borderWidth !== undefined ? el.borderWidth : 2
                        };
                    } else {
                        return {
                            ...base,
                            variable: el.variable
                        };
                    }
                }),
                guides: state.guides.map(g => ({
                    orientation: g.orientation,
                    position_mm: pxToMm(g.position)
                }))
            };

            const json = JSON.stringify(config, null, 2);
            document.getElementById('export-json').value = json;
            openModal('modal-export');
        }

        function copyToClipboard() {
            const textarea = document.getElementById('export-json');
            textarea.select();
            document.execCommand('copy');
            showToast('Copiado al portapapeles');
        }

        function downloadJSON() {
            const json = document.getElementById('export-json').value;
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('config.json descargado');
        }

        // ==========================================
        // MODALS
        // ==========================================
        function openModal(id) {
            document.getElementById(id).classList.add('visible');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('visible');
        }

        // ==========================================
        // TOAST
        // ==========================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 2000);
        }

        // ==========================================
        // UI UPDATE
        // ==========================================
        function updateUI() {
            updateCanvasOrientation();
            updateUndoRedoButtons();
        }

        // ==========================================
        // PREVIEW MODE
        // ==========================================
        function handlePreviewImageUpload(e, imageKey) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                state.previewData.images[imageKey] = event.target.result;

                // Update UI in modal
                const keyMap = {
                    'logo_1': 'logo1',
                    'logo_2': 'logo2',
                    'firma_1': 'firma1',
                    'firma_2': 'firma2'
                };
                const uiKey = keyMap[imageKey];
                const img = document.getElementById(`preview-${uiKey}-img`);
                const text = document.getElementById(`preview-${uiKey}-text`);
                const box = document.getElementById(`preview-${uiKey}-box`);

                img.src = event.target.result;
                img.style.display = 'block';
                text.style.display = 'none';
                box.classList.add('has-image');

                showToast(`${imageKey.replace('_', ' ')} cargada`);
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function applyPreview() {
            // Get values from form
            state.previewData.values = {
                nombre_completo: document.getElementById('sim-nombre').value,
                dni: document.getElementById('sim-dni').value,
                nombre_curso: document.getElementById('sim-curso').value,
                fecha: document.getElementById('sim-fecha').value,
                carga_horaria: document.getElementById('sim-horas').value,
                codigo_validacion: document.getElementById('sim-codigo').value,
                nombre_institucion: document.getElementById('sim-institucion').value,
                firmante_1_nombre: document.getElementById('sim-firmante1-nombre').value,
                firmante_1_cargo: document.getElementById('sim-firmante1-cargo').value,
                firmante_2_nombre: document.getElementById('sim-firmante2-nombre').value,
                firmante_2_cargo: document.getElementById('sim-firmante2-cargo').value
            };

            state.previewMode = document.getElementById('preview-enabled').checked;

            closeModal('modal-preview');
            renderElements();
            updatePreviewIndicator();

            if (state.previewMode) {
                showToast('Modo preview activado');
            } else {
                showToast('Modo preview desactivado');
            }
        }

        function updatePreviewIndicator() {
            const wrapper = document.querySelector('.canvas-wrapper');
            const existingBadge = wrapper.querySelector('.preview-badge');

            if (state.previewMode) {
                wrapper.classList.add('preview-mode-active');
                document.getElementById('btn-preview-mode').classList.add('active');

                if (!existingBadge) {
                    const badge = document.createElement('div');
                    badge.className = 'preview-badge';
                    badge.textContent = 'MODO PREVIEW';
                    wrapper.appendChild(badge);
                }
            } else {
                wrapper.classList.remove('preview-mode-active');
                document.getElementById('btn-preview-mode').classList.remove('active');

                if (existingBadge) {
                    existingBadge.remove();
                }
            }
        }

        // Insertar formato en textarea
        function insertFormat(marker) {
            const textarea = document.getElementById('prop-text');
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);

            let newText;
            if (selectedText) {
                // Hay texto seleccionado - envolverlo con marcadores
                newText = text.substring(0, start) + marker + selectedText + marker + text.substring(end);
                textarea.value = newText;
                // Posicionar cursor después del texto formateado
                textarea.selectionStart = textarea.selectionEnd = end + marker.length * 2;
            } else {
                // No hay selección - insertar marcadores y posicionar cursor en medio
                newText = text.substring(0, start) + marker + marker + text.substring(end);
                textarea.value = newText;
                textarea.selectionStart = textarea.selectionEnd = start + marker.length;
            }

            textarea.focus();
            // Disparar evento input para actualizar el elemento
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Insertar formato en textarea específico (para tabs estudiante/docente)
        function insertFormatInTextarea(textareaId, marker) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);

            let newText;
            if (selectedText) {
                newText = text.substring(0, start) + marker + selectedText + marker + text.substring(end);
                textarea.value = newText;
                textarea.selectionStart = textarea.selectionEnd = end + marker.length * 2;
            } else {
                newText = text.substring(0, start) + marker + marker + text.substring(end);
                textarea.value = newText;
                textarea.selectionStart = textarea.selectionEnd = start + marker.length;
            }

            textarea.focus();
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Cambiar tab aprobacion/finalizacion/docente en párrafos
        function switchParagraphTab(tab) {
            const tabAprobacion = document.getElementById('tab-aprobacion');
            const tabFinalizacion = document.getElementById('tab-finalizacion');
            const tabDocente = document.getElementById('tab-docente');
            const panelAprobacion = document.getElementById('panel-aprobacion');
            const panelFinalizacion = document.getElementById('panel-finalizacion');
            const panelDocente = document.getElementById('panel-docente');

            // Remover active de todos los tabs
            tabAprobacion.classList.remove('active');
            tabFinalizacion.classList.remove('active');
            tabDocente.classList.remove('active');

            // Ocultar todos los paneles
            panelAprobacion.style.display = 'none';
            panelFinalizacion.style.display = 'none';
            panelDocente.style.display = 'none';

            // Activar el tab y panel seleccionado
            if (tab === 'aprobacion') {
                tabAprobacion.classList.add('active');
                panelAprobacion.style.display = 'block';
            } else if (tab === 'finalizacion') {
                tabFinalizacion.classList.add('active');
                panelFinalizacion.style.display = 'block';
            } else if (tab === 'docente') {
                tabDocente.classList.add('active');
                panelDocente.style.display = 'block';
            }
        }

        // Atajos de teclado para formato
        document.addEventListener('keydown', function(e) {
            const textarea = document.getElementById('prop-text');
            if (document.activeElement !== textarea) return;

            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                insertFormat('**');
            } else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                insertFormat('*');
            }
        });

        // Convertir marcadores de formato a HTML
        function applyTextFormatting(text) {
            if (!text) return text;
            // Negrita: **texto** -> <b>texto</b>
            let result = text.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
            // Italica: *texto* -> <i>texto</i> (solo asteriscos simples, no dobles)
            result = result.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<i>$1</i>');
            return result;
        }

        function replaceVariables(text) {
            if (!state.previewMode || !text) return text;

            let result = text;
            const vars = state.previewData.values;

            result = result.replace(/\{\{nombre_completo\}\}/g, vars.nombre_completo);
            result = result.replace(/\{\{dni\}\}/g, vars.dni);
            result = result.replace(/\{\{nombre_curso\}\}/g, vars.nombre_curso);
            result = result.replace(/\{\{fecha\}\}/g, vars.fecha);
            result = result.replace(/\{\{carga_horaria\}\}/g, vars.carga_horaria);
            result = result.replace(/\{\{codigo_validacion\}\}/g, vars.codigo_validacion);
            result = result.replace(/\{\{nombre_institucion\}\}/g, vars.nombre_institucion);
            result = result.replace(/\{\{firmante_1_nombre\}\}/g, vars.firmante_1_nombre);
            result = result.replace(/\{\{firmante_1_cargo\}\}/g, vars.firmante_1_cargo);
            result = result.replace(/\{\{firmante_2_nombre\}\}/g, vars.firmante_2_nombre);
            result = result.replace(/\{\{firmante_2_cargo\}\}/g, vars.firmante_2_cargo);

            // Aplicar formato de texto (negrita, italica)
            result = applyTextFormatting(result);

            return result;
        }

        function getPreviewImage(variable) {
            if (!state.previewMode) return null;

            const imageMap = {
                '{{logo_1}}': state.previewData.images.logo_1,
                '{{logo_2}}': state.previewData.images.logo_2,
                '{{firma_1}}': state.previewData.images.firma_1,
                '{{firma_2}}': state.previewData.images.firma_2
            };

            return imageMap[variable] || null;
        }

        // ==========================================
        // CLIENT PROFILES
        // ==========================================
        function getClientProfiles() {
            const saved = localStorage.getItem('verumax_client_profiles');
            return saved ? JSON.parse(saved) : [];
        }

        function saveClientProfiles(profiles) {
            localStorage.setItem('verumax_client_profiles', JSON.stringify(profiles));
        }

        function saveClientProfile() {
            const profileName = prompt('Nombre del perfil de cliente:', state.previewData.values.nombre_institucion || 'Cliente');
            if (!profileName) return;

            // Collect current form data
            const profile = {
                id: Date.now(),
                name: profileName,
                images: { ...state.previewData.images },
                values: {
                    nombre_completo: document.getElementById('sim-nombre').value,
                    dni: document.getElementById('sim-dni').value,
                    nombre_curso: document.getElementById('sim-curso').value,
                    fecha: document.getElementById('sim-fecha').value,
                    carga_horaria: document.getElementById('sim-horas').value,
                    codigo_validacion: document.getElementById('sim-codigo').value,
                    nombre_institucion: document.getElementById('sim-institucion').value,
                    firmante_1_nombre: document.getElementById('sim-firmante1-nombre').value,
                    firmante_1_cargo: document.getElementById('sim-firmante1-cargo').value,
                    firmante_2_nombre: document.getElementById('sim-firmante2-nombre').value,
                    firmante_2_cargo: document.getElementById('sim-firmante2-cargo').value
                }
            };

            const profiles = getClientProfiles();
            profiles.push(profile);
            saveClientProfiles(profiles);
            loadSavedProfiles();
            showToast(`Perfil "${profileName}" guardado`);

            // Also offer to download
            if (confirm('¿Deseas descargar el perfil como archivo JSON?')) {
                downloadClientProfile(profile);
            }
        }

        function downloadClientProfile(profile) {
            const blob = new Blob([JSON.stringify(profile, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cliente_${profile.name.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleLoadClientProfile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const profile = JSON.parse(event.target.result);
                    applyClientProfile(profile);

                    // Ask if want to save to local list
                    if (confirm(`Perfil "${profile.name}" cargado. ¿Guardarlo en la lista local?`)) {
                        const profiles = getClientProfiles();
                        profile.id = Date.now(); // New ID
                        profiles.push(profile);
                        saveClientProfiles(profiles);
                        loadSavedProfiles();
                    }

                    showToast(`Perfil "${profile.name}" cargado`);
                } catch (err) {
                    showToast('Error al cargar el perfil');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function applyClientProfile(profile) {
            // Apply images
            state.previewData.images = { ...profile.images };

            // Update image previews in modal
            ['logo_1', 'logo_2', 'firma_1', 'firma_2'].forEach(key => {
                const uiKey = key.replace('_', '');
                const img = document.getElementById(`preview-${uiKey}-img`);
                const text = document.getElementById(`preview-${uiKey}-text`);
                const box = document.getElementById(`preview-${uiKey}-box`);

                if (profile.images[key]) {
                    img.src = profile.images[key];
                    img.style.display = 'block';
                    text.style.display = 'none';
                    box.classList.add('has-image');
                } else {
                    img.style.display = 'none';
                    text.style.display = 'block';
                    box.classList.remove('has-image');
                }
            });

            // Apply values to form
            document.getElementById('sim-nombre').value = profile.values.nombre_completo || '';
            document.getElementById('sim-dni').value = profile.values.dni || '';
            document.getElementById('sim-curso').value = profile.values.nombre_curso || '';
            document.getElementById('sim-fecha').value = profile.values.fecha || '';
            document.getElementById('sim-horas').value = profile.values.carga_horaria || '';
            document.getElementById('sim-codigo').value = profile.values.codigo_validacion || '';
            document.getElementById('sim-institucion').value = profile.values.nombre_institucion || '';
            document.getElementById('sim-firmante1-nombre').value = profile.values.firmante_1_nombre || '';
            document.getElementById('sim-firmante1-cargo').value = profile.values.firmante_1_cargo || '';
            document.getElementById('sim-firmante2-nombre').value = profile.values.firmante_2_nombre || '';
            document.getElementById('sim-firmante2-cargo').value = profile.values.firmante_2_cargo || '';

            // Update state
            state.previewData.values = { ...profile.values };
        }

        function loadSavedProfiles() {
            const container = document.getElementById('saved-profiles-list');
            const profiles = getClientProfiles();

            if (profiles.length === 0) {
                container.innerHTML = '<span class="no-profiles">No hay perfiles guardados</span>';
                return;
            }

            container.innerHTML = profiles.map(p => `
                <div class="profile-pill" onclick="loadProfile(${p.id})">
                    <span>${p.name}</span>
                    <span class="delete-profile" onclick="event.stopPropagation(); deleteProfile(${p.id})" title="Eliminar">×</span>
                </div>
            `).join('');
        }

        function loadProfile(id) {
            const profiles = getClientProfiles();
            const profile = profiles.find(p => p.id === id);
            if (profile) {
                applyClientProfile(profile);
                showToast(`Perfil "${profile.name}" cargado`);
            }
        }

        function deleteProfile(id) {
            if (!confirm('¿Eliminar este perfil?')) return;

            let profiles = getClientProfiles();
            profiles = profiles.filter(p => p.id !== id);
            saveClientProfiles(profiles);
            loadSavedProfiles();
            showToast('Perfil eliminado');
        }

        // ==========================================
        // START
        // ==========================================
        init();
    </script>
</body>
</html>
